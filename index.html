<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>VertexScripts - Script Uploader & Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All previous styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        /* ... (all existing CSS remains exactly the same) ... */
        
        /* NEW STYLES FOR VIDEO PLAYER OPTIONS */
        .video-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .video-option-btn {
            flex: 1;
            min-width: 140px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .video-option-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        .video-option-btn.active {
            background: rgba(75, 207, 250, 0.2);
            border-color: #4bcffa;
            box-shadow: 0 5px 15px rgba(75, 207, 250, 0.2);
        }
        
        .video-option-btn i {
            font-size: 1.2rem;
        }
        
        .video-embed-container {
            margin-top: 15px;
            display: none;
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
        }
        
        .video-embed-container.active {
            display: block;
        }
        
        .video-embed-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
        }
        
        .watch-here-thumbnail {
            position: relative;
            cursor: pointer;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .watch-here-thumbnail img {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }
        
        .watch-here-thumbnail:hover img {
            transform: scale(1.05);
        }
        
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            transition: background 0.3s ease;
        }
        
        .watch-here-thumbnail:hover .play-overlay {
            background: rgba(0, 0, 0, 0.7);
        }
        
        /* Enhanced like/dislike styles */
        .like-btn.liked i {
            animation: likePulse 0.5s ease;
        }
        
        .dislike-btn.disliked i {
            animation: dislikePulse 0.5s ease;
        }
        
        @keyframes likePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        @keyframes dislikePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Toast notification for voting */
        .vote-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 14px;
            animation: fadeInOut 3s ease;
            max-width: 90%;
            text-align: center;
            border-left: 4px solid #4bcffa;
        }
        
        /* ... (rest of existing CSS remains the same) ... */
    </style>
</head>
<body>
    <!-- Authentication Container (remains the same) -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-tabs">
                <button class="auth-tab active" id="loginTab">Login</button>
                <button class="auth-tab" id="registerTab">Register</button>
            </div>
            
            <form id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginUsername">Username</label>
                    <input type="text" id="loginUsername" placeholder="Enter username" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter password" required>
                </div>
                
                <div class="auth-error" id="loginError"></div>
                
                <button type="submit" class="btn">Login</button>
            </form>
            
            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" placeholder="Choose username" required>
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="Choose password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm password" required>
                </div>
                
                <div class="auth-error" id="registerError"></div>
                
                <button type="submit" class="btn">Register</button>
            </form>
        </div>
    </div>
    
    <!-- Main Application Container (remains the same) -->
    <div id="appContainer" style="display: none;">
        <div class="container">
            <header>
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-code"></i>
                        <h1>VertexScripts</h1>
                    </div>
                    
                    <button class="mobile-menu-btn" id="mobileMenuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                    
                    <div class="user-info">
                        <span id="currentUserDisplay"></span>
                        <div class="dropdown">
                            <button class="dropdown-btn">
                                <i class="fas fa-user-circle"></i>
                                <span id="usernameDisplay"></span>
                                <i class="fas fa-caret-down"></i>
                            </button>
                            <div class="dropdown-content">
                                <a href="#" id="viewChannelBtn">
                                    <i class="fas fa-user"></i> My Channel
                                </a>
                                <a href="#" id="subscriptionsBtn">
                                    <i class="fas fa-bell"></i> Subscriptions
                                </a>
                                <a href="#" id="deleteAccountBtn">
                                    <i class="fas fa-trash"></i> Delete Account
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mobile-dropdown-content" id="mobileDropdown">
                    <a href="#" id="mobileViewChannelBtn">
                        <i class="fas fa-user"></i> My Channel
                    </a>
                    <a href="#" id="mobileSubscriptionsBtn">
                        <i class="fas fa-bell"></i> Subscriptions
                    </a>
                    <a href="#" id="mobileDeleteAccountBtn">
                        <i class="fas fa-trash"></i> Delete Account
                    </a>
                </div>
                
                <div class="header-controls">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="searchInput" placeholder="Search scripts...">
                    </div>
                    <button class="upload-btn" id="showUploadBtn">
                        <i class="fas fa-upload"></i> Upload Script
                    </button>
                    <div class="credit">VertexScripts</div>
                </div>
            </header>
            
            <main class="main-content">
                <!-- Channel View Section (remains the same) -->
                <section id="channelContainer" class="card channel-container">
                    <button class="back-to-dashboard" id="backToDashboardFromChannel">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                    
                    <div class="channel-header">
                        <h2><i class="fas fa-user"></i> My Channel</h2>
                        <p>Welcome to your channel, <span id="channelUsername"></span>!</p>
                        
                        <div class="channel-stats">
                            <div class="channel-stat">
                                <div class="channel-stat-number" id="channelSubscribers">0</div>
                                <div class="channel-stat-label">Subscribers</div>
                            </div>
                            <div class="channel-stat">
                                <div class="channel-stat-number" id="channelTotalLikes">0</div>
                                <div class="channel-stat-label">Total Likes</div>
                            </div>
                            <div class="channel-stat">
                                <div class="channel-stat-number" id="channelTotalViews">0</div>
                                <div class="channel-stat-label">Total Views</div>
                            </div>
                            <div class="channel-stat">
                                <div class="channel-stat-number" id="channelScriptsCount">0</div>
                                <div class="channel-stat-label">Scripts</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3><i class="fas fa-code"></i> My Scripts</h3>
                    
                    <div id="channelScriptsList" class="channel-scripts-grid">
                        <!-- User's scripts will be dynamically added here -->
                    </div>
                </section>
                
                <!-- Subscriptions Section (remains the same) -->
                <section id="subscriptionsContainer" class="card subscriptions-container">
                    <button class="back-to-dashboard" id="backToDashboardFromSubs">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                    
                    <h2><i class="fas fa-bell"></i> Subscriptions</h2>
                    <p>Latest scripts from creators you follow</p>
                    
                    <div id="subscriptionsList" class="subscriptions-grid">
                        <!-- Subscription scripts will be dynamically added here -->
                    </div>
                </section>
                
                <!-- Dashboard Section (remains the same) -->
                <section id="dashboardContainer" class="card">
                    <div class="dashboard-header">
                        <div class="dashboard-title">
                            <h2><i class="fas fa-tachometer-alt"></i> Script Dashboard</h2>
                        </div>
                        <div class="dashboard-stats">
                            <div class="stat">
                                <div class="stat-number" id="totalScripts">0</div>
                                <div class="stat-label">Total Scripts</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number" id="myScripts">0</div>
                                <div class="stat-label">My Scripts</div>
                            </div>
                        </div>
                    </div>
                    <p>Browse and manage all available scripts</p>
                    
                    <div id="scriptsList" class="scripts-grid">
                        <!-- Scripts will be dynamically added here -->
                    </div>
                </section>
                
                <!-- Upload Script Section (remains the same) -->
                <section id="uploadContainer" class="card upload-container">
                    <button class="back-to-dashboard" id="backToDashboardBtn">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </button>
                    
                    <h2><i class="fas fa-upload"></i> Upload New Script</h2>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="scriptName">Script Name</label>
                            <input type="text" id="scriptName" placeholder="Enter script name" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Script Thumbnail</label>
                            <div class="upload-options">
                                <button type="button" class="upload-option-btn active" id="thumbnailOptionBtn">
                                    <i class="fas fa-image"></i>
                                    <span>Upload Image</span>
                                </button>
                                <button type="button" class="upload-option-btn" id="youtubeOptionBtn">
                                    <i class="fab fa-youtube"></i>
                                    <span>YouTube Video</span>
                                </button>
                            </div>
                            
                            <!-- Image Upload Option -->
                            <div id="thumbnailUploadSection" class="thumbnail-section">
                                <div class="file-upload">
                                    <label for="thumbnailInput" class="file-upload-label">
                                        <i class="fas fa-image"></i>
                                        <span id="fileLabelText">Click to upload thumbnail image</span>
                                    </label>
                                    <input type="file" id="thumbnailInput" accept="image/*">
                                </div>
                                <div class="thumbnail-preview" id="thumbnailPreview">
                                    <img id="previewImage" src="" alt="Thumbnail Preview">
                                </div>
                            </div>
                            
                            <!-- YouTube Option -->
                            <div id="youtubeUploadSection" class="youtube-section" style="display: none;">
                                <input type="text" id="youtubeLink" placeholder="Enter YouTube video URL (e.g., https://youtube.com/watch?v=...)">
                                <div class="youtube-preview" id="youtubePreview">
                                    <!-- YouTube preview will be shown here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="scriptLink">Script Download Link</label>
                            <input type="text" id="scriptLink" placeholder="https://example.com/script.zip" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Unlock Steps (Users must complete these before accessing your script)</label>
                            <div id="stepsContainer">
                                <!-- Vertex step is added by default and cannot be removed -->
                            </div>
                            
                            <div class="button-group">
                                <button type="button" id="addStepBtn" class="btn btn-secondary">
                                    <i class="fas fa-plus"></i> Add Step
                                </button>
                                <button type="button" id="addYoutubeStepBtn" class="btn btn-secondary">
                                    <i class="fab fa-youtube"></i> Add YouTube Step
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn mobile-full-width">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Script
                        </button>
                    </form>
                </section>
            </main>
            
            <!-- Unlock Modal (remains the same) -->
            <div id="unlockModal" class="modal">
                <div class="modal-content">
                    <h3>Unlock Script: <span id="unlockScriptName"></span></h3>
                    <p>Complete all steps to unlock the script</p>
                    
                    <div id="stepChecks">
                        <!-- Step checks will be dynamically added here -->
                    </div>
                    
                    <div class="progress-bar">
                        <div id="progress" class="progress"></div>
                    </div>
                    
                    <div class="timer" id="timer">20</div>
                    
                    <button id="accessLinkBtn" class="btn unlock-btn" disabled>
                        <i class="fas fa-lock"></i> Unlocking... Please wait
                    </button>
                    
                    <button id="cancelBtn" class="btn btn-secondary" style="margin-top: 10px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
            
            <!-- Script View Modal - UPDATED WITH VIDEO OPTIONS -->
            <div id="scriptViewModal" class="modal script-view-modal">
                <div class="script-view-content">
                    <div class="script-view-header">
                        <h3 id="viewScriptName"></h3>
                        <button class="close-view" id="closeScriptView">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="script-view-body">
                        <!-- NEW VIDEO OPTIONS SECTION -->
                        <div class="video-options" id="videoOptionsContainer" style="display: none;">
                            <button class="video-option-btn active" id="watchHereBtn">
                                <i class="fas fa-play-circle"></i> Watch Here
                            </button>
                            <button class="video-option-btn" id="watchYoutubeBtn">
                                <i class="fab fa-youtube"></i> Watch on YouTube
                            </button>
                        </div>
                        
                        <!-- Video Embed Container (for Watch Here option) -->
                        <div class="video-embed-container" id="videoEmbedContainer">
                            <!-- YouTube video will be embedded here -->
                        </div>
                        
                        <div class="script-view-thumbnail" id="viewThumbnailContainer">
                            <!-- Thumbnail or YouTube video will be shown here -->
                        </div>
                        
                        <div class="script-details">
                            <div class="script-uploader">
                                <i class="fas fa-user"></i>
                                <span id="viewScriptAuthor"></span>
                                <span id="viewScriptDate"></span>
                            </div>
                        </div>
                        
                        <div class="script-view-stats">
                            <div class="stat-item">
                                <button class="like-btn" id="viewLikeBtn">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span id="viewLikeCount">0</span>
                                </button>
                            </div>
                            <div class="stat-item">
                                <button class="dislike-btn" id="viewDislikeBtn">
                                    <i class="fas fa-thumbs-down"></i>
                                    <span id="viewDislikeCount">0</span>
                                </button>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-eye"></i>
                                <span id="viewViewCount">0</span> views
                            </div>
                            <button class="subscribe-btn" id="viewSubscribeBtn">
                                <i class="fas fa-bell"></i>
                                <span id="subscribeText">Subscribe</span>
                            </button>
                        </div>
                        
                        <button class="btn" id="viewUnlockBtn">
                            <i class="fas fa-unlock-alt"></i> Unlock Script
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Delete Confirmation Modal (remains the same) -->
            <div id="deleteModal" class="modal">
                <div class="modal-content">
                    <h3><i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i> Confirm Delete</h3>
                    <p id="deleteMessage">Are you sure you want to delete this script? This action cannot be undone.</p>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;">
                        <button id="confirmDeleteBtn" class="btn btn-danger mobile-full-width">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button id="cancelDeleteBtn" class="btn btn-secondary mobile-full-width">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Delete Account Modal (remains the same) -->
            <div id="deleteAccountModal" class="modal">
                <div class="modal-content">
                    <h3><i class="fas fa-exclamation-triangle" style="color: #ff6b6b;"></i> Delete Account</h3>
                    <p>This will permanently delete your account, all your uploaded scripts, subscriptions, likes, and everything associated with your account. This action cannot be undone!</p>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="confirmUsername">Type your username to confirm</label>
                        <input type="text" id="confirmUsername" placeholder="Enter your username">
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;">
                        <button id="confirmAccountDeleteBtn" class="btn btn-danger mobile-full-width">
                            <i class="fas fa-trash"></i> Permanently Delete Account
                        </button>
                        <button id="cancelAccountDeleteBtn" class="btn btn-secondary mobile-full-width">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <footer>
                <p>VertexScripts Dashboard &copy; 2023 | All scripts are property of their respective owners</p>
            </footer>
        </div>
    </div>

    <script>
        // ============ ENHANCED STORAGE SYSTEM ============
        class VertexStorage {
            constructor() {
                this.initStorage();
            }
            
            initStorage() {
                // Initialize all storage keys
                if (!localStorage.getItem('vertex_users')) {
                    localStorage.setItem('vertex_users', JSON.stringify({}));
                }
                if (!localStorage.getItem('vertex_scripts')) {
                    localStorage.setItem('vertex_scripts', JSON.stringify([]));
                }
                if (!localStorage.getItem('vertex_interactions')) {
                    localStorage.setItem('vertex_interactions', JSON.stringify({}));
                }
                if (!localStorage.getItem('vertex_subscriptions')) {
                    localStorage.setItem('vertex_subscriptions', JSON.stringify({}));
                }
                if (!localStorage.getItem('vertex_current_user')) {
                    localStorage.setItem('vertex_current_user', JSON.stringify(null));
                }
                
                // NEW: Initialize video viewing preferences
                if (!localStorage.getItem('vertex_video_prefs')) {
                    localStorage.setItem('vertex_video_prefs', JSON.stringify({}));
                }
            }
            
            // User management (unchanged)
            registerUser(username, password) {
                const users = JSON.parse(localStorage.getItem('vertex_users'));
                
                if (users[username]) {
                    return { success: false, error: 'Username already exists' };
                }
                
                if (password === username) {
                    return { success: false, error: 'Password cannot be the same as username' };
                }
                
                if (password.length < 6) {
                    return { success: false, error: 'Password must be at least 6 characters' };
                }
                
                const hashedPassword = this.hashPassword(password);
                
                users[username] = {
                    username: username,
                    password: hashedPassword,
                    createdAt: new Date().toISOString(),
                    isAdmin: username === 'plstealme2'
                };
                
                localStorage.setItem('vertex_users', JSON.stringify(users));
                return { success: true };
            }
            
            loginUser(username, password) {
                const users = JSON.parse(localStorage.getItem('vertex_users'));
                
                if (!users[username]) {
                    return { success: false, error: 'Invalid username or password' };
                }
                
                const hashedPassword = this.hashPassword(password);
                if (users[username].password !== hashedPassword) {
                    return { success: false, error: 'Invalid username or password' };
                }
                
                return { success: true, user: users[username] };
            }
            
            hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }
            
            setCurrentUser(username) {
                localStorage.setItem('vertex_current_user', JSON.stringify(username));
            }
            
            getCurrentUser() {
                const username = JSON.parse(localStorage.getItem('vertex_current_user'));
                if (!username) return null;
                
                const users = JSON.parse(localStorage.getItem('vertex_users'));
                return users[username] || null;
            }
            
            logoutUser() {
                localStorage.setItem('vertex_current_user', JSON.stringify(null));
            }
            
            deleteUser(username) {
                const users = JSON.parse(localStorage.getItem('vertex_users'));
                delete users[username];
                localStorage.setItem('vertex_users', JSON.stringify(users));
                
                // Delete user's scripts
                let scripts = JSON.parse(localStorage.getItem('vertex_scripts'));
                scripts = scripts.filter(script => script.uploader !== username);
                localStorage.setItem('vertex_scripts', JSON.stringify(scripts));
                
                // Delete user's subscriptions
                const subscriptions = JSON.parse(localStorage.getItem('vertex_subscriptions'));
                delete subscriptions[username];
                localStorage.setItem('vertex_subscriptions', JSON.stringify(subscriptions));
                
                // Delete user's interactions
                const interactions = JSON.parse(localStorage.getItem('vertex_interactions'));
                delete interactions[username];
                localStorage.setItem('vertex_interactions', JSON.stringify(interactions));
                
                // Remove as subscriber from other users
                Object.keys(subscriptions).forEach(user => {
                    if (subscriptions[user] && subscriptions[user].includes(username)) {
                        const index = subscriptions[user].indexOf(username);
                        if (index > -1) {
                            subscriptions[user].splice(index, 1);
                        }
                    }
                });
                
                localStorage.setItem('vertex_subscriptions', JSON.stringify(subscriptions));
                this.logoutUser();
            }
            
            // Script management (unchanged)
            saveScript(script) {
                let scripts = JSON.parse(localStorage.getItem('vertex_scripts'));
                scripts.push(script);
                localStorage.setItem('vertex_scripts', JSON.stringify(scripts));
            }
            
            getScripts() {
                return JSON.parse(localStorage.getItem('vertex_scripts'));
            }
            
            getScriptsByUser(username) {
                const scripts = this.getScripts();
                return scripts.filter(script => script.uploader === username);
            }
            
            deleteScript(scriptId) {
                let scripts = JSON.parse(localStorage.getItem('vertex_scripts'));
                scripts = scripts.filter(script => script.id !== scriptId);
                localStorage.setItem('vertex_scripts', JSON.stringify(scripts));
            }
            
            updateScript(updatedScript) {
                let scripts = JSON.parse(localStorage.getItem('vertex_scripts'));
                const index = scripts.findIndex(script => script.id === updatedScript.id);
                if (index !== -1) {
                    scripts[index] = updatedScript;
                    localStorage.setItem('vertex_scripts', JSON.stringify(scripts));
                }
            }
            
            // ENHANCED: Interaction tracking with cooldown
            recordInteraction(username, scriptId, type) {
                let interactions = JSON.parse(localStorage.getItem('vertex_interactions'));
                
                if (!interactions[username]) {
                    interactions[username] = {};
                }
                
                if (!interactions[username][scriptId]) {
                    interactions[username][scriptId] = {};
                }
                
                // Check if there's a cooldown (prevent rapid clicking)
                const now = Date.now();
                const lastInteraction = interactions[username][scriptId]._timestamp || 0;
                const cooldown = 1000; // 1 second cooldown
                
                if (now - lastInteraction < cooldown) {
                    return interactions[username][scriptId][type] || false;
                }
                
                // Store timestamp
                interactions[username][scriptId]._timestamp = now;
                
                // Toggle interaction
                if (interactions[username][scriptId][type]) {
                    // Remove existing interaction
                    delete interactions[username][scriptId][type];
                } else {
                    // Remove opposite interaction if it exists
                    const oppositeType = type === 'like' ? 'dislike' : 'like';
                    if (interactions[username][scriptId][oppositeType]) {
                        delete interactions[username][scriptId][oppositeType];
                    }
                    
                    // Add new interaction
                    interactions[username][scriptId][type] = true;
                }
                
                localStorage.setItem('vertex_interactions', JSON.stringify(interactions));
                
                return interactions[username][scriptId][type] || false;
            }
            
            hasInteracted(username, scriptId, type) {
                const interactions = JSON.parse(localStorage.getItem('vertex_interactions'));
                return interactions[username] && 
                       interactions[username][scriptId] && 
                       interactions[username][scriptId][type];
            }
            
            // NEW: Get all interactions for a script
            getScriptInteractions(scriptId) {
                const interactions = JSON.parse(localStorage.getItem('vertex_interactions'));
                let likes = 0;
                let dislikes = 0;
                
                Object.keys(interactions).forEach(username => {
                    if (interactions[username][scriptId]) {
                        if (interactions[username][scriptId].like) likes++;
                        if (interactions[username][scriptId].dislike) dislikes++;
                    }
                });
                
                return { likes, dislikes };
            }
            
            // Subscription management (unchanged)
            subscribe(subscriber, creator) {
                if (subscriber === creator) return false;
                
                let subscriptions = JSON.parse(localStorage.getItem('vertex_subscriptions'));
                
                if (!subscriptions[subscriber]) {
                    subscriptions[subscriber] = [];
                }
                
                // Toggle subscription
                if (subscriptions[subscriber].includes(creator)) {
                    const index = subscriptions[subscriber].indexOf(creator);
                    subscriptions[subscriber].splice(index, 1);
                    localStorage.setItem('vertex_subscriptions', JSON.stringify(subscriptions));
                    return false;
                } else {
                    subscriptions[subscriber].push(creator);
                    localStorage.setItem('vertex_subscriptions', JSON.stringify(subscriptions));
                    return true;
                }
            }
            
            isSubscribed(subscriber, creator) {
                const subscriptions = JSON.parse(localStorage.getItem('vertex_subscriptions'));
                return subscriptions[subscriber] && subscriptions[subscriber].includes(creator);
            }
            
            getSubscriptions(username) {
                const subscriptions = JSON.parse(localStorage.getItem('vertex_subscriptions'));
                return subscriptions[username] || [];
            }
            
            getSubscribers(username) {
                const subscriptions = JSON.parse(localStorage.getItem('vertex_subscriptions'));
                const subscribers = [];
                
                Object.keys(subscriptions).forEach(subscriber => {
                    if (subscriptions[subscriber] && subscriptions[subscriber].includes(username)) {
                        subscribers.push(subscriber);
                    }
                });
                
                return subscribers;
            }
            
            // Channel stats (unchanged)
            getUserChannelStats(username) {
                const scripts = this.getScriptsByUser(username);
                let totalLikes = 0;
                let totalDislikes = 0;
                let totalViews = 0;
                
                scripts.forEach(script => {
                    const interactions = this.getScriptInteractions(script.id);
                    totalLikes += interactions.likes || 0;
                    totalDislikes += interactions.dislikes || 0;
                    totalViews += script.views || 0;
                });
                
                const subscribers = this.getSubscribers(username);
                
                return {
                    scriptsCount: scripts.length,
                    totalLikes,
                    totalDislikes,
                    totalViews,
                    subscribers: subscribers.length,
                    subscriberList: subscribers
                };
            }
            
            // NEW: Video preference management
            setVideoPreference(username, scriptId, preference) {
                let prefs = JSON.parse(localStorage.getItem('vertex_video_prefs'));
                
                if (!prefs[username]) {
                    prefs[username] = {};
                }
                
                prefs[username][scriptId] = preference;
                localStorage.setItem('vertex_video_prefs', JSON.stringify(prefs));
            }
            
            getVideoPreference(username, scriptId) {
                const prefs = JSON.parse(localStorage.getItem('vertex_video_prefs'));
                return prefs[username] && prefs[username][scriptId] || 'watchHere';
            }
        }

        // ============ MAIN APPLICATION ============
        const storage = new VertexStorage();
        let currentUser = null;
        let scripts = [];
        let nextId = 1;
        let currentUnlockScript = null;
        let currentStep = 0;
        let countdown = 20;
        let countdownInterval = null;
        let completedSteps = new Set();
        let stepTimers = {};
        let scriptToDelete = null;
        let currentViewScript = null;
        let uploadType = 'thumbnail';
        let currentVideoPreference = 'watchHere'; // 'watchHere' or 'watchYoutube'

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            currentUser = storage.getCurrentUser();
            
            if (currentUser) {
                showApp();
            } else {
                showAuth();
            }
            
            setupEventListeners();
            loadScripts();
            updateStats();
        });

        function setupEventListeners() {
            // Auth tabs
            document.getElementById('loginTab').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('registerTab').addEventListener('click', () => switchAuthTab('register'));
            
            // Auth forms
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            
            // Upload type selection
            document.getElementById('thumbnailOptionBtn').addEventListener('click', () => switchUploadType('thumbnail'));
            document.getElementById('youtubeOptionBtn').addEventListener('click', () => switchUploadType('youtube'));
            
            // YouTube link preview
            document.getElementById('youtubeLink').addEventListener('input', handleYoutubeLink);
            
            // Main app buttons
            document.getElementById('uploadForm').addEventListener('submit', uploadScript);
            document.getElementById('addStepBtn').addEventListener('click', addStep);
            document.getElementById('addYoutubeStepBtn').addEventListener('click', addYouTubeStep);
            document.getElementById('thumbnailInput').addEventListener('change', handleThumbnailPreview);
            document.getElementById('cancelBtn').addEventListener('click', closeUnlockModal);
            document.getElementById('accessLinkBtn').addEventListener('click', accessScriptLink);
            document.getElementById('showUploadBtn').addEventListener('click', showUploadForm);
            document.getElementById('backToDashboardBtn').addEventListener('click', showDashboard);
            document.getElementById('searchInput').addEventListener('input', filterScripts);
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteScript);
            document.getElementById('cancelDeleteBtn').addEventListener('click', cancelDelete);
            document.getElementById('confirmAccountDeleteBtn').addEventListener('click', confirmAccountDelete);
            document.getElementById('cancelAccountDeleteBtn').addEventListener('click', cancelAccountDelete);
            document.getElementById('viewChannelBtn').addEventListener('click', showChannel);
            document.getElementById('mobileViewChannelBtn').addEventListener('click', showChannel);
            document.getElementById('subscriptionsBtn').addEventListener('click', showSubscriptions);
            document.getElementById('mobileSubscriptionsBtn').addEventListener('click', showSubscriptions);
            document.getElementById('backToDashboardFromSubs').addEventListener('click', showDashboard);
            document.getElementById('backToDashboardFromChannel').addEventListener('click', showDashboard);
            document.getElementById('deleteAccountBtn').addEventListener('click', showDeleteAccountModal);
            document.getElementById('mobileDeleteAccountBtn').addEventListener('click', showDeleteAccountModal);
            document.getElementById('mobileMenuBtn').addEventListener('click', toggleMobileMenu);
            document.getElementById('closeScriptView').addEventListener('click', closeScriptView);
            document.getElementById('viewUnlockBtn').addEventListener('click', unlockFromView);
            document.getElementById('viewLikeBtn').addEventListener('click', handleLike);
            document.getElementById('viewDislikeBtn').addEventListener('click', handleDislike);
            document.getElementById('viewSubscribeBtn').addEventListener('click', handleSubscribe);
            
            // NEW: Video option buttons
            document.getElementById('watchHereBtn').addEventListener('click', () => switchVideoOption('watchHere'));
            document.getElementById('watchYoutubeBtn').addEventListener('click', () => switchVideoOption('watchYoutube'));
            
            // Window events
            window.addEventListener('orientationchange', () => setTimeout(handleResize, 100));
            window.addEventListener('resize', debounce(handleResize, 250));
            window.addEventListener('click', closeMobileMenuOnClickOutside);
            
            // Initialize
            addVertexStep();
            handleResize();
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            if (tab === 'login') {
                document.getElementById('loginTab').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.getElementById('registerTab').classList.add('active');
                document.getElementById('registerForm').classList.add('active');
            }
        }

        function switchUploadType(type) {
            uploadType = type;
            
            document.getElementById('thumbnailOptionBtn').classList.toggle('active', type === 'thumbnail');
            document.getElementById('youtubeOptionBtn').classList.toggle('active', type === 'youtube');
            
            document.getElementById('thumbnailUploadSection').style.display = type === 'thumbnail' ? 'block' : 'none';
            document.getElementById('youtubeUploadSection').style.display = type === 'youtube' ? 'block' : 'none';
            
            document.getElementById('thumbnailInput').required = type === 'thumbnail';
            document.getElementById('youtubeLink').required = type === 'youtube';
        }

        // NEW: Switch video viewing option
        function switchVideoOption(option) {
            currentVideoPreference = option;
            
            // Update button states
            document.getElementById('watchHereBtn').classList.toggle('active', option === 'watchHere');
            document.getElementById('watchYoutubeBtn').classList.toggle('active', option === 'watchYoutube');
            
            // Show/hide appropriate content
            if (option === 'watchHere') {
                document.getElementById('videoEmbedContainer').classList.add('active');
                document.getElementById('viewThumbnailContainer').style.display = 'none';
                
                // Embed YouTube video
                if (currentViewScript && currentViewScript.youtubeVideo) {
                    const videoId = extractYoutubeVideoId(currentViewScript.youtubeVideo);
                    if (videoId) {
                        document.getElementById('videoEmbedContainer').innerHTML = `
                            <iframe 
                                src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        `;
                    }
                }
            } else {
                // Watch on YouTube option
                document.getElementById('videoEmbedContainer').classList.remove('active');
                document.getElementById('viewThumbnailContainer').style.display = 'block';
                
                // Save preference for future views
                if (currentUser && currentViewScript) {
                    storage.setVideoPreference(currentUser.username, currentViewScript.id, option);
                }
            }
        }

        function extractYoutubeVideoId(url) {
            if (!url) return null;
            
            // Handle various YouTube URL formats
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/|youtube\.com\/shorts\/)([^&\n?#]+)/,
                /youtube\.com\/.*[?&]v=([^&]+)/,
                /youtu\.be\/([^?#]+)/
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1].substring(0, 11); // YouTube IDs are 11 chars
                }
            }
            
            return null;
        }

        function handleYoutubeLink(e) {
            const youtubeLink = e.target.value;
            const youtubePreview = document.getElementById('youtubePreview');
            
            if (!youtubeLink) {
                youtubePreview.style.display = 'none';
                return;
            }
            
            const videoId = extractYoutubeVideoId(youtubeLink);
            
            if (videoId) {
                youtubePreview.innerHTML = `
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
                youtubePreview.style.display = 'block';
            } else {
                youtubePreview.style.display = 'none';
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const result = storage.loginUser(username, password);
            
            if (result.success) {
                storage.setCurrentUser(username);
                currentUser = result.user;
                showApp();
                showToast('Logged in successfully!');
            } else {
                document.getElementById('loginError').textContent = result.error;
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                document.getElementById('registerError').textContent = 'Passwords do not match';
                return;
            }
            
            const result = storage.registerUser(username, password);
            
            if (result.success) {
                storage.setCurrentUser(username);
                currentUser = storage.getCurrentUser();
                showApp();
                showToast('Account created successfully!');
            } else {
                document.getElementById('registerError').textContent = result.error;
            }
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            document.getElementById('usernameDisplay').textContent = currentUser.username;
            document.getElementById('currentUserDisplay').textContent = `Welcome, ${currentUser.username}`;
            
            showDashboard();
            loadScripts();
            updateStats();
        }

        function showDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            toggleMobileMenu();
        }

        function confirmAccountDelete() {
            const confirmUsername = document.getElementById('confirmUsername').value;
            
            if (confirmUsername !== currentUser.username) {
                showToast('Username does not match');
                return;
            }
            
            storage.deleteUser(currentUser.username);
            currentUser = null;
            
            document.getElementById('deleteAccountModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            document.getElementById('confirmUsername').value = '';
            
            showAuth();
            showToast('Account deleted successfully');
        }

        function cancelAccountDelete() {
            document.getElementById('deleteAccountModal').style.display = 'none';
            document.getElementById('confirmUsername').value = '';
            document.body.style.overflow = 'auto';
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileDropdown');
            menu.classList.toggle('active');
            
            if (window.innerWidth < 768) {
                const uploadBtn = document.getElementById('showUploadBtn');
                uploadBtn.addEventListener('click', function() {
                    menu.classList.add('show-upload');
                });
            }
        }

        function closeMobileMenuOnClickOutside(e) {
            const menu = document.getElementById('mobileDropdown');
            const menuBtn = document.getElementById('mobileMenuBtn');
            
            if (menu.classList.contains('active') && 
                !menu.contains(e.target) && 
                !menuBtn.contains(e.target)) {
                menu.classList.remove('active');
                menu.classList.remove('show-upload');
            }
        }

        function showChannel() {
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('subscriptionsContainer').style.display = 'none';
            document.getElementById('channelContainer').style.display = 'block';
            
            loadChannelData();
            toggleMobileMenu();
        }

        function loadChannelData() {
            if (!currentUser) return;
            
            const stats = storage.getUserChannelStats(currentUser.username);
            const userScripts = storage.getScriptsByUser(currentUser.username);
            
            document.getElementById('channelUsername').textContent = currentUser.username;
            document.getElementById('channelSubscribers').textContent = stats.subscribers;
            document.getElementById('channelTotalLikes').textContent = stats.totalLikes;
            document.getElementById('channelTotalViews').textContent = stats.totalViews;
            document.getElementById('channelScriptsCount').textContent = stats.scriptsCount;
            
            const container = document.getElementById('channelScriptsList');
            
            if (userScripts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-code"></i>
                        <h3>No scripts uploaded yet</h3>
                        <p>Upload your first script to get started!</p>
                        <button class="btn" style="margin-top: 20px;" id="channelUploadBtn">
                            <i class="fas fa-upload"></i> Upload First Script
                        </button>
                    </div>
                `;
                
                document.getElementById('channelUploadBtn').addEventListener('click', showUploadForm);
                return;
            }
            
            userScripts.sort((a, b) => new Date(b.uploadDateTime) - new Date(a.uploadDateTime));
            
            container.innerHTML = '';
            userScripts.forEach(script => {
                const scriptCard = createScriptCard(script);
                container.appendChild(scriptCard);
            });
        }

        function showSubscriptions() {
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('channelContainer').style.display = 'none';
            document.getElementById('subscriptionsContainer').style.display = 'block';
            
            loadSubscriptions();
            toggleMobileMenu();
        }

        function loadSubscriptions() {
            const subscriptions = storage.getSubscriptions(currentUser.username);
            const allScripts = storage.getScripts();
            
            const subscriptionScripts = allScripts.filter(script => 
                subscriptions.includes(script.uploader)
            );
            
            subscriptionScripts.sort((a, b) => new Date(b.uploadDateTime) - new Date(a.uploadDateTime));
            
            const container = document.getElementById('subscriptionsList');
            
            if (subscriptionScripts.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No subscriptions yet</h3>
                        <p>Subscribe to creators to see their latest scripts here</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            subscriptionScripts.forEach(script => {
                const scriptCard = createScriptCard(script);
                container.appendChild(scriptCard);
            });
        }

        function handleSubscribe() {
            if (!currentUser || !currentViewScript) return;
            
            const creator = currentViewScript.uploader;
            
            if (creator === currentUser.username) {
                showToast("You can't subscribe to yourself");
                return;
            }
            
            const subscribed = storage.subscribe(currentUser.username, creator);
            
            if (subscribed) {
                document.getElementById('subscribeText').textContent = 'Subscribed';
                document.getElementById('viewSubscribeBtn').classList.add('subscribed');
                showToast(`Subscribed to ${creator}`);
            } else {
                document.getElementById('subscribeText').textContent = 'Subscribe';
                document.getElementById('viewSubscribeBtn').classList.remove('subscribed');
                showToast(`Unsubscribed from ${creator}`);
            }
            
            if (document.getElementById('channelContainer').style.display === 'block') {
                loadChannelData();
            }
        }

        // ENHANCED: Handle like with advanced checks
        function handleLike() {
            if (!currentUser || !currentViewScript) return;
            
            const scriptId = currentViewScript.id;
            const liked = storage.recordInteraction(currentUser.username, scriptId, 'like');
            
            // Update counts from all interactions
            const interactions = storage.getScriptInteractions(scriptId);
            currentViewScript.likes = interactions.likes;
            currentViewScript.dislikes = interactions.dislikes;
            
            // Save updated script
            storage.updateScript(currentViewScript);
            
            // Update UI
            document.getElementById('viewLikeCount').textContent = currentViewScript.likes || 0;
            document.getElementById('viewDislikeCount').textContent = currentViewScript.dislikes || 0;
            document.getElementById('viewLikeBtn').classList.toggle('liked', liked);
            
            // Ensure dislike button is in correct state
            const hasDisliked = storage.hasInteracted(currentUser.username, scriptId, 'dislike');
            document.getElementById('viewDislikeBtn').classList.toggle('disliked', hasDisliked);
            
            showVoteToast(liked ? 'liked' : 'unliked');
            renderScripts();
            
            if (document.getElementById('channelContainer').style.display === 'block') {
                loadChannelData();
            }
        }

        // ENHANCED: Handle dislike with advanced checks
        function handleDislike() {
            if (!currentUser || !currentViewScript) return;
            
            const scriptId = currentViewScript.id;
            const disliked = storage.recordInteraction(currentUser.username, scriptId, 'dislike');
            
            // Update counts from all interactions
            const interactions = storage.getScriptInteractions(scriptId);
            currentViewScript.likes = interactions.likes;
            currentViewScript.dislikes = interactions.dislikes;
            
            // Save updated script
            storage.updateScript(currentViewScript);
            
            // Update UI
            document.getElementById('viewDislikeCount').textContent = currentViewScript.dislikes || 0;
            document.getElementById('viewLikeCount').textContent = currentViewScript.likes || 0;
            document.getElementById('viewDislikeBtn').classList.toggle('disliked', disliked);
            
            // Ensure like button is in correct state
            const hasLiked = storage.hasInteracted(currentUser.username, scriptId, 'like');
            document.getElementById('viewLikeBtn').classList.toggle('liked', hasLiked);
            
            showVoteToast(disliked ? 'disliked' : 'undisliked');
            renderScripts();
            
            if (document.getElementById('channelContainer').style.display === 'block') {
                loadChannelData();
            }
        }

        function updateScriptInStorage(script) {
            storage.updateScript(script);
        }

        // UPDATED: Show script view with video options
        function showScriptView(script) {
            currentViewScript = script;
            
            // Record view
            if (currentUser && !storage.hasInteracted(currentUser.username, script.id, 'view')) {
                storage.recordInteraction(currentUser.username, script.id, 'view');
                script.views = (script.views || 0) + 1;
                updateScriptInStorage(script);
            }
            
            // Update UI
            document.getElementById('viewScriptName').textContent = script.name;
            document.getElementById('viewScriptAuthor').textContent = `Uploaded by ${script.uploader}`;
            document.getElementById('viewScriptDate').textContent = ` on ${script.uploadDate}`;
            
            // Get current interaction counts
            const interactions = storage.getScriptInteractions(script.id);
            document.getElementById('viewLikeCount').textContent = interactions.likes || 0;
            document.getElementById('viewDislikeCount').textContent = interactions.dislikes || 0;
            document.getElementById('viewViewCount').textContent = script.views || 0;
            
            // Show/hide video options based on script type
            const videoOptionsContainer = document.getElementById('videoOptionsContainer');
            if (script.youtubeVideo) {
                videoOptionsContainer.style.display = 'flex';
                
                // Get user's video preference or default to 'watchHere'
                const preference = currentUser ? 
                    storage.getVideoPreference(currentUser.username, script.id) : 
                    'watchHere';
                
                currentVideoPreference = preference;
                
                // Set initial video display
                if (preference === 'watchHere') {
                    switchVideoOption('watchHere');
                } else {
                    switchVideoOption('watchYoutube');
                }
            } else {
                videoOptionsContainer.style.display = 'none';
                document.getElementById('videoEmbedContainer').classList.remove('active');
            }
            
            // Update thumbnail/video
            const thumbnailContainer = document.getElementById('viewThumbnailContainer');
            if (script.youtubeVideo && currentVideoPreference === 'watchYoutube') {
                // Show YouTube thumbnail with play button
                const videoId = extractYoutubeVideoId(script.youtubeVideo);
                thumbnailContainer.innerHTML = `
                    <div class="watch-here-thumbnail" onclick="window.open('${script.youtubeVideo}', '_blank')">
                        <img src="https://img.youtube.com/vi/${videoId}/maxresdefault.jpg" 
                             onerror="this.src='https://img.youtube.com/vi/${videoId}/hqdefault.jpg'"
                             alt="YouTube Video">
                        <div class="play-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else if (script.thumbnail) {
                // Show image thumbnail
                thumbnailContainer.innerHTML = `
                    <img src="${script.thumbnail}" alt="${script.name}">
                `;
            } else {
                // Show default
                thumbnailContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(45deg, #0c2461, #1e3799);">
                        <i class="fas fa-code" style="font-size: 3rem; color: #4bcffa;"></i>
                    </div>
                `;
            }
            
            // Check if user is subscribed
            const isSubscribed = storage.isSubscribed(currentUser.username, script.uploader);
            document.getElementById('subscribeText').textContent = isSubscribed ? 'Subscribed' : 'Subscribe';
            document.getElementById('viewSubscribeBtn').classList.toggle('subscribed', isSubscribed);
            
            // Check if user has liked/disliked
            const hasLiked = storage.hasInteracted(currentUser.username, script.id, 'like');
            const hasDisliked = storage.hasInteracted(currentUser.username, script.id, 'dislike');
            document.getElementById('viewLikeBtn').classList.toggle('liked', hasLiked);
            document.getElementById('viewDislikeBtn').classList.toggle('disliked', hasDisliked);
            
            // Disable subscribe button if user is the uploader
            if (script.uploader === currentUser.username) {
                document.getElementById('viewSubscribeBtn').style.display = 'none';
            } else {
                document.getElementById('viewSubscribeBtn').style.display = 'flex';
            }
            
            document.getElementById('scriptViewModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeScriptView() {
            // Stop any embedded video
            const iframe = document.querySelector('#videoEmbedContainer iframe');
            if (iframe) {
                iframe.src = iframe.src.replace('autoplay=1', 'autoplay=0');
            }
            
            document.getElementById('scriptViewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentViewScript = null;
        }

        function unlockFromView() {
            closeScriptView();
            startUnlockProcess(currentViewScript);
        }

        // ============ ORIGINAL FUNCTIONALITY (UPDATED) ============
        function loadScripts() {
            scripts = storage.getScripts();
            if (scripts.length > 0) {
                nextId = Math.max(...scripts.map(s => s.id)) + 1;
            }
        }

        function showDashboard() {
            document.getElementById('dashboardContainer').style.display = 'block';
            document.getElementById('uploadContainer').style.display = 'none';
            document.getElementById('subscriptionsContainer').style.display = 'none';
            document.getElementById('channelContainer').style.display = 'none';
            renderScripts();
            updateStats();
            window.scrollTo(0, 0);
            closeMobileMenu();
        }

        function showUploadForm() {
            document.getElementById('dashboardContainer').style.display = 'none';
            document.getElementById('uploadContainer').style.display = 'block';
            document.getElementById('subscriptionsContainer').style.display = 'none';
            document.getElementById('channelContainer').style.display = 'none';
            
            document.getElementById('uploadForm').reset();
            document.getElementById('thumbnailPreview').style.display = 'none';
            document.getElementById('youtubePreview').style.display = 'none';
            document.getElementById('fileLabelText').textContent = 'Click to upload thumbnail image';
            document.getElementById('youtubeLink').value = '';
            
            switchUploadType('thumbnail');
            
            const stepsContainer = document.getElementById('stepsContainer');
            stepsContainer.innerHTML = '';
            addVertexStep();
            
            window.scrollTo(0, 0);
            closeMobileMenu();
        }

        function closeMobileMenu() {
            const menu = document.getElementById('mobileDropdown');
            menu.classList.remove('active');
            menu.classList.remove('show-upload');
        }

        function addVertexStep() {
            const stepsContainer = document.getElementById('stepsContainer');
            
            const stepContainer = document.createElement('div');
            stepContainer.className = 'step-container vertex-step';
            stepContainer.setAttribute('data-step', 1);
            stepContainer.innerHTML = `
                <div class="step-header">
                    <div class="step-title">
                        <span class="step-counter">1</span>
                        <i class="fab fa-youtube"></i> Subscribe to VertexR_S (Required)
                    </div>
                    <button type="button" class="remove-step"><i class="fas fa-times"></i></button>
                </div>
                <input type="text" class="step-url" value="https://m.youtube.com/@VertexR_S" readonly>
            `;
            
            stepsContainer.appendChild(stepContainer);
        }

        function addStep() {
            const stepNumber = document.querySelectorAll('.step-container').length;
            addCustomStep(stepNumber, "", "");
        }

        function addYouTubeStep() {
            const stepNumber = document.querySelectorAll('.step-container').length;
            addCustomStep(stepNumber, "Subscribe to YouTube Channel", "https://youtube.com");
        }

        function addCustomStep(stepNumber, name, url) {
            const stepsContainer = document.getElementById('stepsContainer');
            
            const stepContainer = document.createElement('div');
            stepContainer.className = 'step-container';
            stepContainer.setAttribute('data-step', stepNumber);
            stepContainer.innerHTML = `
                <div class="step-header">
                    <div class="step-title">
                        <span class="step-counter">${stepNumber}</span>
                        <input type="text" class="step-name-input" placeholder="Step name" value="${name}" style="background: transparent; border: none; color: white; width: 200px; min-width: 150px; font-size: 14px;">
                    </div>
                    <button type="button" class="remove-step"><i class="fas fa-times"></i></button>
                </div>
                <input type="text" class="step-url" placeholder="https://example.com" value="${url}" required>
            `;
            
            stepsContainer.appendChild(stepContainer);
            
            stepContainer.querySelector('.remove-step').addEventListener('click', function() {
                stepContainer.remove();
                updateStepNumbers();
            });
            
            const nameInput = stepContainer.querySelector('.step-name-input');
            nameInput.addEventListener('input', function() {
                updateStepNumbers();
            });
        }

        function updateStepNumbers() {
            const stepsContainer = document.getElementById('stepsContainer');
            const stepContainers = stepsContainer.querySelectorAll('.step-container');
            
            stepContainers.forEach((container, index) => {
                const stepNumber = index + 1;
                container.setAttribute('data-step', stepNumber);
                
                const counter = container.querySelector('.step-counter');
                counter.textContent = stepNumber;
                
                const nameInput = container.querySelector('.step-name-input');
                if (nameInput) {
                    nameInput.placeholder = `Step ${stepNumber} name`;
                }
            });
        }

        function updateStats() {
            const allScripts = storage.getScripts();
            const totalScripts = allScripts.length;
            const myScripts = allScripts.filter(script => script.uploader === currentUser.username).length;
            
            document.getElementById('totalScripts').textContent = totalScripts;
            document.getElementById('myScripts').textContent = myScripts;
        }

        function filterScripts() {
            const query = document.getElementById('searchInput').value;
            const scriptsList = document.getElementById('scriptsList');
            
            if (!query.trim()) {
                renderScripts();
                return;
            }
            
            const filteredScripts = scripts.filter(script => 
                script.name.toLowerCase().includes(query.toLowerCase()) ||
                script.uploader.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredScripts.length === 0) {
                scriptsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No scripts found</h3>
                        <p>No scripts match your search query: "${query}"</p>
                    </div>
                `;
                return;
            }
            
            scriptsList.innerHTML = '';
            filteredScripts.forEach(script => {
                const scriptCard = createScriptCard(script);
                scriptsList.appendChild(scriptCard);
            });
        }

        function calculateScriptScore(script) {
            let score = 0;
            
            const interactions = storage.getScriptInteractions(script.id);
            score += interactions.likes * 10;
            score -= interactions.dislikes * 5;
            score += (script.views || 0) * 0.1;
            
            if (script.pinned) {
                score += 1000;
            }
            
            const ageInDays = (new Date() - new Date(script.uploadDateTime)) / (1000 * 60 * 60 * 24);
            if (ageInDays < 7) {
                score += 50 - (ageInDays * 5);
            }
            
            return score;
        }

        function renderScripts() {
            const scriptsList = document.getElementById('scriptsList');
            loadScripts();
            
            if (scripts.length === 0) {
                scriptsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-code"></i>
                        <h3>No scripts uploaded yet</h3>
                        <p>Upload your first script to get started!</p>
                        <button class="btn" style="margin-top: 20px;" id="emptyUploadBtn">
                            <i class="fas fa-upload"></i> Upload First Script
                        </button>
                    </div>
                `;
                
                document.getElementById('emptyUploadBtn').addEventListener('click', showUploadForm);
                return;
            }
            
            const scoredScripts = scripts.map(script => ({
                ...script,
                score: calculateScriptScore(script)
            }));
            
            scoredScripts.sort((a, b) => b.score - a.score);
            
            scriptsList.innerHTML = '';
            scoredScripts.forEach(script => {
                const scriptCard = createScriptCard(script);
                scriptsList.appendChild(scriptCard);
            });
        }

        function createScriptCard(script) {
            const scriptCard = document.createElement('div');
            scriptCard.className = 'script-card';
            scriptCard.dataset.id = script.id;
            
            const pinIcon = script.pinned ? '<div class="pin-icon"><i class="fas fa-thumbtack"></i></div>' : '';
            
            const canDelete = currentUser.username === 'plstealme2' || script.uploader === currentUser.username;
            const deleteBtn = canDelete ? `
                <button class="action-btn delete-btn" data-id="${script.id}" aria-label="Delete script">
                    <i class="fas fa-trash"></i>
                </button>
            ` : '';
            
            const pinBtn = currentUser.username === 'plstealme2' ? `
                <button class="action-btn pin-btn ${script.pinned ? 'pinned' : ''}" data-id="${script.id}" aria-label="${script.pinned ? 'Unpin' : 'Pin'} script">
                    <i class="fas fa-thumbtack"></i>
                </button>
            ` : '';
            
            const interactions = storage.getScriptInteractions(script.id);
            
            let thumbnailHtml = '';
            if (script.youtubeVideo) {
                const videoId = extractYoutubeVideoId(script.youtubeVideo);
                thumbnailHtml = `
                    <div class="script-thumbnail youtube-thumbnail" onclick="event.stopPropagation(); showScriptView(${JSON.stringify(script).replace(/"/g, '&quot;')})">
                        <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" 
                             onerror="this.src='https://img.youtube.com/vi/${videoId}/default.jpg'"
                             alt="${script.name}" loading="lazy">
                        <div class="play-button" style="width: 50px; height: 50px; font-size: 1.5rem;">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else if (script.thumbnail) {
                thumbnailHtml = `
                    <div class="script-thumbnail">
                        <img src="${script.thumbnail}" alt="${script.name}" loading="lazy">
                    </div>
                `;
            } else {
                thumbnailHtml = `
                    <div class="script-thumbnail">
                        <i class="fas fa-code"></i>
                    </div>
                `;
            }
            
            scriptCard.innerHTML = `
                ${pinIcon}
                <div class="script-card-actions">
                    ${pinBtn}
                    ${deleteBtn}
                </div>
                ${thumbnailHtml}
                <div class="script-info">
                    <div class="script-title">${script.name}</div>
                    <div class="script-details">
                        <div class="script-uploader">
                            <i class="fas fa-user"></i>
                            ${script.uploader}
                            <span> ${script.uploadDate}</span>
                        </div>
                        <div class="script-stats">
                            <span><i class="fas fa-thumbs-up"></i> ${interactions.likes || 0}</span>
                            <span><i class="fas fa-eye"></i> ${script.views || 0}</span>
                        </div>
                    </div>
                    <div class="steps-indicator">
                        ${script.steps.map((step, index) => 
                            `<div class="step-dot ${index === 0 ? 'active' : ''}"></div>`
                        ).join('')}
                    </div>
                    <button class="btn unlock-script-btn" data-id="${script.id}">
                        <i class="fas fa-unlock-alt"></i> Unlock Script
                    </button>
                </div>
            `;
            
            scriptCard.addEventListener('click', function(e) {
                if (!e.target.closest('button') && !e.target.closest('.youtube-thumbnail')) {
                    showScriptView(script);
                }
            });
            
            scriptCard.querySelector('.unlock-script-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                startUnlockProcess(script);
            });
            
            if (canDelete) {
                scriptCard.querySelector('.delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    confirmDelete(script.id);
                });
            }
            
            if (currentUser.username === 'plstealme2') {
                scriptCard.querySelector('.pin-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    togglePinScript(script.id);
                });
            }
            
            return scriptCard;
        }

        function togglePinScript(scriptId) {
            let scripts = storage.getScripts();
            const script = scripts.find(s => s.id === scriptId);
            
            if (script) {
                script.pinned = !script.pinned;
                localStorage.setItem('vertex_scripts', JSON.stringify(scripts));
                renderScripts();
                showToast(script.pinned ? 'Script pinned to top' : 'Script unpinned');
            }
        }

        function confirmDelete(scriptId) {
            const script = scripts.find(s => s.id === scriptId);
            if (script && (currentUser.username === 'plstealme2' || script.uploader === currentUser.username)) {
                scriptToDelete = scriptId;
                document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${script.name}"? This action cannot be undone.`;
                document.getElementById('deleteModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function confirmDeleteScript() {
            if (scriptToDelete) {
                storage.deleteScript(scriptToDelete);
                scriptToDelete = null;
                renderScripts();
                updateStats();
                showToast('Script deleted successfully');
                
                if (document.getElementById('channelContainer').style.display === 'block') {
                    loadChannelData();
                }
            }
            document.getElementById('deleteModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function cancelDelete() {
            scriptToDelete = null;
            document.getElementById('deleteModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function uploadScript(e) {
            e.preventDefault();
            
            const scriptName = document.getElementById('scriptName').value;
            const scriptLink = document.getElementById('scriptLink').value;
            
            if (!scriptLink) {
                showToast('Please enter a script download link');
                return;
            }
            
            let thumbnail = '';
            let youtubeVideo = '';
            
            if (uploadType === 'thumbnail') {
                const thumbnailInput = document.getElementById('thumbnailInput');
                if (!thumbnailInput.files || thumbnailInput.files.length === 0) {
                    showToast('Please select a thumbnail image');
                    return;
                }
                
                const file = thumbnailInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    thumbnail = event.target.result;
                    finishUpload(scriptName, scriptLink, thumbnail, youtubeVideo);
                };
                
                reader.readAsDataURL(file);
            } else {
                youtubeVideo = document.getElementById('youtubeLink').value;
                if (!youtubeVideo) {
                    showToast('Please enter a YouTube video URL');
                    return;
                }
                
                const videoId = extractYoutubeVideoId(youtubeVideo);
                if (!videoId) {
                    showToast('Please enter a valid YouTube video URL');
                    return;
                }
                
                thumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                finishUpload(scriptName, scriptLink, thumbnail, youtubeVideo);
            }
        }

        function finishUpload(scriptName, scriptLink, thumbnail, youtubeVideo) {
            const stepContainers = document.querySelectorAll('.step-container');
            const steps = [];
            
            stepContainers.forEach(container => {
                const urlInput = container.querySelector('.step-url');
                const nameInput = container.querySelector('.step-name-input');
                const stepTitle = container.querySelector('.step-title');
                
                let stepName = '';
                if (container.classList.contains('vertex-step')) {
                    stepName = 'Subscribe to VertexR_S';
                } else if (nameInput) {
                    stepName = nameInput.value || `Step ${steps.length + 1}`;
                } else if (stepTitle) {
                    stepName = stepTitle.textContent.replace('Subscribe to VertexR_S (Required)', 'Subscribe to VertexR_S').trim();
                }
                
                if (urlInput.value) {
                    steps.push({
                        url: urlInput.value,
                        name: stepName
                    });
                }
            });
            
            const newScript = {
                id: nextId++,
                name: scriptName,
                thumbnail: thumbnail,
                youtubeVideo: youtubeVideo,
                scriptLink: scriptLink,
                steps: steps,
                uploader: currentUser.username,
                uploadDate: new Date().toLocaleDateString(),
                uploadDateTime: new Date().toISOString(),
                likes: 0,
                dislikes: 0,
                views: 0,
                pinned: false
            };
            
            storage.saveScript(newScript);
            showDashboard();
            showToast(`Script "${scriptName}" uploaded successfully!`);
        }

        function startUnlockProcess(script) {
            currentUnlockScript = script;
            currentStep = 0;
            countdown = 20;
            completedSteps.clear();
            
            const modal = document.getElementById('unlockModal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            document.getElementById('unlockScriptName').textContent = script.name.length > 30 ? script.name.substring(0, 30) + '...' : script.name;
            
            const stepChecks = document.getElementById('stepChecks');
            stepChecks.innerHTML = '';
            
            script.steps.forEach((step, index) => {
                const stepCheck = document.createElement('div');
                stepCheck.className = 'step-check';
                stepCheck.id = `stepCheck${index}`;
                stepCheck.innerHTML = `
                    <div class="check-circle" id="checkCircle${index}">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="step-text">
                        <div class="step-name">${step.name.length > 40 ? step.name.substring(0, 40) + '...' : step.name}</div>
                        <div class="step-desc">${step.url}</div>
                        <button class="step-link-btn" id="stepLinkBtn${index}" data-url="${step.url}" aria-label="Open ${step.name}">
                            <i class="fas fa-external-link-alt"></i> Open Link
                        </button>
                    </div>
                `;
                stepChecks.appendChild(stepCheck);
                
                document.getElementById(`stepLinkBtn${index}`).addEventListener('click', function() {
                    const stepIndex = parseInt(this.id.replace('stepLinkBtn', ''));
                    const stepUrl = this.getAttribute('data-url');
                    startStepTimer(stepIndex, stepUrl);
                });
            });
            
            document.getElementById('timer').textContent = countdown;
            document.getElementById('progress').style.width = '0%';
            document.getElementById('accessLinkBtn').disabled = true;
            document.getElementById('accessLinkBtn').innerHTML = '<i class="fas fa-lock"></i> Unlocking... Please wait';
            
            processNextStep();
        }

        function processNextStep() {
            if (currentStep >= currentUnlockScript.steps.length) {
                startCountdown();
                return;
            }
            
            if (completedSteps.has(currentStep)) {
                const stepCheck = document.getElementById(`stepCheck${currentStep}`);
                stepCheck.classList.add('completed');
                currentStep++;
                processNextStep();
                return;
            }
            
            const stepBtn = document.getElementById(`stepLinkBtn${currentStep}`);
            stepBtn.disabled = false;
        }

        function startStepTimer(stepIndex, stepUrl) {
            const stepBtn = document.getElementById(`stepLinkBtn${stepIndex}`);
            stepBtn.disabled = true;
            stepBtn.innerHTML = '<i class="fas fa-clock"></i> Waiting...';
            
            window.open(stepUrl, '_blank');
            
            const checkCircle = document.getElementById(`checkCircle${stepIndex}`);
            checkCircle.classList.add('spinning');
            
            const stepCheck = document.getElementById(`stepCheck${stepIndex}`);
            stepCheck.classList.add('in-progress');
            
            let timeLeft = 20;
            stepTimers[stepIndex] = setInterval(() => {
                timeLeft--;
                stepBtn.innerHTML = `<i class="fas fa-clock"></i> ${timeLeft}s`;
                
                if (timeLeft <= 0) {
                    clearInterval(stepTimers[stepIndex]);
                    delete stepTimers[stepIndex];
                    completeStep(stepIndex);
                }
            }, 1000);
        }

        function completeStep(stepIndex) {
            const checkCircle = document.getElementById(`checkCircle${stepIndex}`);
            checkCircle.classList.remove('spinning');
            
            const stepCheck = document.getElementById(`stepCheck${stepIndex}`);
            stepCheck.classList.remove('in-progress');
            stepCheck.classList.add('completed');
            
            const checkIcon = checkCircle.querySelector('i');
            checkIcon.style.opacity = '1';
            
            const stepBtn = document.getElementById(`stepLinkBtn${stepIndex}`);
            stepBtn.innerHTML = '<i class="fas fa-check"></i> Completed';
            stepBtn.disabled = true;
            
            completedSteps.add(stepIndex);
            
            if (stepIndex === currentStep) {
                currentStep++;
                processNextStep();
            }
        }

        function startCountdown() {
            document.getElementById('progress').style.width = '100%';
            
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('timer').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    
                    const accessBtn = document.getElementById('accessLinkBtn');
                    accessBtn.disabled = false;
                    accessBtn.innerHTML = '<i class="fas fa-unlock-alt"></i> Access Script Download';
                }
            }, 1000);
        }

        function accessScriptLink() {
            if (currentUnlockScript && !this.disabled) {
                window.open(currentUnlockScript.scriptLink, '_blank');
                closeUnlockModal();
            }
        }

        function closeUnlockModal() {
            Object.keys(stepTimers).forEach(stepIndex => {
                clearInterval(stepTimers[stepIndex]);
            });
            stepTimers = {};
            
            clearInterval(countdownInterval);
            document.getElementById('unlockModal').style.display = 'none';
            currentUnlockScript = null;
            document.body.style.overflow = 'auto';
        }

        function handleThumbnailPreview(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('previewImage');
                    preview.src = event.target.result;
                    document.getElementById('thumbnailPreview').style.display = 'block';
                    document.getElementById('fileLabelText').textContent = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
                };
                reader.readAsDataURL(file);
            }
        }

        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        // NEW: Special toast for voting actions
        function showVoteToast(action) {
            const messages = {
                'liked': 'You liked this script',
                'unliked': 'You removed your like',
                'disliked': 'You disliked this script',
                'undisliked': 'You removed your dislike'
            };
            
            const existingToast = document.querySelector('.vote-toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = 'vote-toast';
            toast.textContent = messages[action] || 'Action recorded';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 2000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function handleResize() {
            const isMobile = window.innerWidth < 768;
            const searchInput = document.getElementById('searchInput');
            
            if (isMobile) {
                searchInput.placeholder = "Search...";
                document.querySelectorAll('.modal-content').forEach(modal => {
                    modal.style.maxHeight = '85vh';
                });
            } else {
                searchInput.placeholder = "Search scripts...";
            }
        }
    </script>
</body>
</html>
