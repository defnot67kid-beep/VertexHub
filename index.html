<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VertexHub 12.0 · Advanced Stats + Multi-Platform Video</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <!-- Rumble Embed API -->
    <script src="https://rumble.com/embedJS/u3.17.2.min.js?api=1"></script>
    
    <style>
        /* ============ RESET & VARIABLES ============ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f52e0;
            --primary-light: #a5b4fc;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --info: #3b82f6;
            --dark: #03050a;
            --dark-light: #0c0f16;
            --dark-card: #14181f;
            --dark-input: #1e242c;
            --text: #ffffff;
            --text-dim: #94a3b8;
            --text-dimmer: #64748b;
            --border: rgba(255,255,255,0.05);
            --border-light: rgba(255,255,255,0.1);
            --border-active: rgba(99,102,241,0.5);
            --shadow: 0 25px 50px -12px rgba(0,0,0,0.8);
            --shadow-glow: 0 0 20px rgba(99,102,241,0.3);
            --gradient-primary: linear-gradient(135deg, #6366f1, #8b5cf6);
            --gradient-premium: linear-gradient(135deg, #f59e0b, #d97706);
            --gradient-success: linear-gradient(135deg, #10b981, #059669);
            --gradient-danger: linear-gradient(135deg, #ef4444, #dc2626);
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --subscribe: #ff0000;
            
            --pc-sidebar-width: 280px;
            --mobile-sidebar-width: 85vw;
            
            /* Platform colors */
            --tiktok: #000000;
            --youtube: #ff0000;
            --instagram: #e4405f;
            --twitter: #1da1f2;
            --discord: #5865f2;
            --twitch: #9146ff;
            --rumble: #85c742;
        }

        body {
            font-family: var(--font-sans);
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        @media (min-width: 1024px) {
            .dashboard {
                display: grid;
                grid-template-columns: var(--pc-sidebar-width) 1fr;
                min-height: 100vh;
            }

            .sidebar {
                background: var(--dark-light);
                border-right: 1px solid var(--border);
                padding: 28px 20px;
                position: sticky;
                top: 0;
                height: 100vh;
                overflow-y: auto;
            }

            .content {
                padding: 32px 40px;
            }

            .scripts-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
            }

            .templates-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 20px;
            }

            .mobile-menu-toggle {
                display: none !important;
            }
        }

        @media (max-width: 1023px) {
            .dashboard {
                display: block;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                width: var(--mobile-sidebar-width);
                height: 100vh;
                background: var(--dark-light);
                z-index: 1000;
                padding: 24px 16px;
                transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                overflow-y: auto;
            }

            .sidebar.active {
                left: 0;
            }

            .content {
                padding: 20px 16px;
                min-height: 100vh;
            }

            .mobile-menu-toggle {
                display: flex !important;
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 999;
                background: var(--gradient-primary);
                border: none;
                color: white;
                width: 48px;
                height: 48px;
                border-radius: 12px;
                font-size: 24px;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .scripts-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .templates-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
        }

        /* ============ COMMON STYLES ============ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-light);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .glass-card {
            background: rgba(18, 22, 33, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: 24px;
            box-shadow: var(--shadow);
        }

        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at 10% 30%, #1a1f2e, var(--dark));
            padding: 20px;
        }

        .auth-card {
            background: rgba(18, 22, 33, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 32px;
            padding: 40px;
            width: 100%;
            max-width: 460px;
            box-shadow: var(--shadow);
            animation: slideUp 0.6s ease;
        }

        /* ... (keep all existing styles up to auth-card) ... */
        
        /* Enhanced Stats Cards */
        .stats-grid-enhanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card-enhanced {
            background: linear-gradient(135deg, var(--dark-card), var(--dark-input));
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .stat-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: rgba(99,102,241,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary);
        }

        .stat-value-large {
            font-size: 42px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 14px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* Analytics Dashboard */
        .analytics-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .analytics-chart {
            background: var(--dark-card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            height: 200px;
            margin-top: 20px;
        }

        .chart-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .chart-bar {
            width: 100%;
            background: var(--gradient-primary);
            border-radius: 8px 8px 0 0;
            min-height: 4px;
            transition: height 0.3s ease;
            position: relative;
        }

        .chart-bar:hover {
            opacity: 0.9;
        }

        .chart-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-card);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s ease;
            border: 1px solid var(--border);
        }

        .chart-bar:hover .chart-bar-value {
            opacity: 1;
        }

        .chart-label {
            font-size: 12px;
            color: var(--text-dim);
            text-align: center;
        }

        /* Video Platform Badges */
        .platform-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 100px;
            font-size: 11px;
            font-weight: 600;
        }

        .platform-badge.youtube {
            background: rgba(255,0,0,0.2);
            color: #ff0000;
        }

        .platform-badge.rumble {
            background: rgba(133,199,66,0.2);
            color: #85c742;
        }

        .platform-badge.tiktok {
            background: rgba(0,0,0,0.3);
            color: #ffffff;
        }

        /* Multi-Platform Video Container */
        .video-platform-container {
            position: relative;
            width: 100%;
            border-radius: 28px;
            overflow: hidden;
            margin: 32px 0;
            box-shadow: 0 0 0 2px rgba(99,102,241,0.3);
            aspect-ratio: 16 / 9;
            background: black;
        }

        .video-platform-container.shorts {
            aspect-ratio: 9 / 16;
            max-width: 400px;
            margin: 0 auto;
        }

        .video-embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 10;
            cursor: default;
        }

        .video-timer-display {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 18px;
            font-weight: 600;
            border: 1px solid var(--primary);
            box-shadow: var(--shadow-glow);
            z-index: 20;
            backdrop-filter: blur(5px);
        }

        .video-warning {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(239,68,68,0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 14px;
            z-index: 30;
            animation: pulse 2s infinite;
            white-space: nowrap;
        }

        /* Device Stats */
        .device-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }

        .device-stat-card {
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .device-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .device-stat-label {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .device-stat-detail {
            font-size: 11px;
            color: var(--text-dimmer);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        /* Conversion Funnel */
        .funnel-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin: 24px 0;
            flex-wrap: wrap;
        }

        .funnel-step {
            flex: 1;
            min-width: 100px;
            background: rgba(99,102,241,0.1);
            border-radius: 12px;
            padding: 16px 8px;
            text-align: center;
            position: relative;
        }

        .funnel-step::after {
            content: '→';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-dim);
            font-size: 18px;
        }

        .funnel-step:last-child::after {
            display: none;
        }

        .funnel-value {
            font-size: 24px;
            font-weight: 700;
        }

        .funnel-label {
            font-size: 11px;
            color: var(--text-dim);
        }

        .funnel-rate {
            font-size: 12px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .export-btn {
            background: var(--dark-input);
            border: 1px solid var(--border);
            padding: 12px 24px;
            border-radius: 100px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        /* Real-time Stats */
        .realtime-stats {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(5,150,105,0.05));
            border: 1px solid var(--success);
            border-radius: 16px;
            padding: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 12px;
            height: 12px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Keep all existing animation keyframes */
        @keyframes pulseRing {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUpFade {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    
    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- Rumble Embed API -->
    <script src="https://rumble.com/embedJS/u3.17.2.min.js?api=1"></script>

    <script>
        // ============ FIREBASE CONFIGURATION ============
        const firebaseConfig = {
            apiKey: "AIzaSyBS4BaGo5r1V5rANl2qu_fYQG3RjE91gtE",
            authDomain: "vertexhub-9f0d2.firebaseapp.com",
            projectId: "vertexhub-9f0d2",
            storageBucket: "vertexhub-9f0d2.firebasestorage.app",
            messagingSenderId: "159837255599",
            appId: "1:159837255599:web:e69bb8959e22508242a15a"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============ APP STATE ============
        let currentUser = null;
        let isPremium = false;
        let currentScripts = [];
        let currentTemplate = null;
        let youtubePlayer = null;
        let rumblePlayer = null;
        let hasWatchedFullVideo = false;
        let antiSkipActive = true;
        let skipAttempts = 0;
        let activeStepStates = {};
        let viewedScripts = {};
        let unlockedScripts = {};
        let deviceId = null;
        let allScripts = [];
        let currentVideoModal = null;
        let deviceInteractions = {};
        
        // Enhanced Stats Tracking
        let analyticsData = {
            views: {},
            unlocks: {},
            deviceStats: {},
            hourlyStats: {},
            dailyStats: {},
            conversionFunnels: {},
            realtimeViews: []
        };
        
        // Multi-Platform Video Support
        const VIDEO_PLATFORMS = {
            youtube: {
                name: 'YouTube',
                icon: 'fab fa-youtube',
                color: '#ff0000',
                embedBase: 'https://www.youtube.com/embed/',
                shortsBase: 'https://www.youtube.com/embed/',
                watchBase: 'https://www.youtube.com/watch?v='
            },
            rumble: {
                name: 'Rumble',
                icon: 'fas fa-video',
                color: '#85c742',
                embedBase: 'https://rumble.com/embed/',
                patterns: ['rumble.com/v', 'rumble.com/embed']
            },
            tiktok: {
                name: 'TikTok',
                icon: 'fab fa-tiktok',
                color: '#000000',
                embedBase: 'https://www.tiktok.com/embed/v2/',
                patterns: ['tiktok.com/@', 'tiktok.com/video']
            }
        };

        // ============ ENHANCED STATS FUNCTIONS ============

        // Track view with detailed analytics
        async function trackDetailedView(scriptId, stepIndex = null, source = 'direct') {
            const timestamp = Date.now();
            const hour = new Date(timestamp).getHours();
            const date = new Date(timestamp).toISOString().split('T')[0];
            
            const viewData = {
                scriptId,
                userId: currentUser?.uid || 'anonymous',
                deviceId,
                timestamp,
                hour,
                date,
                source,
                stepIndex,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                referrer: document.referrer || 'direct',
                timeOnPage: 0,
                completed: false
            };

            // Store in analytics collection
            try {
                await db.collection('detailedAnalytics').add(viewData);
                
                // Update realtime stats
                analyticsData.realtimeViews.push({
                    ...viewData,
                    id: Date.now()
                });
                
                // Keep only last 100 realtime views
                if (analyticsData.realtimeViews.length > 100) {
                    analyticsData.realtimeViews.shift();
                }
                
                // Update hourly stats
                if (!analyticsData.hourlyStats[date]) {
                    analyticsData.hourlyStats[date] = {};
                }
                if (!analyticsData.hourlyStats[date][hour]) {
                    analyticsData.hourlyStats[date][hour] = { views: 0, unlocks: 0 };
                }
                analyticsData.hourlyStats[date][hour].views++;
                
                // Update device stats
                if (!analyticsData.deviceStats[deviceId]) {
                    analyticsData.deviceStats[deviceId] = {
                        firstSeen: timestamp,
                        lastSeen: timestamp,
                        viewCount: 0,
                        unlockCount: 0,
                        scriptsViewed: [],
                        scriptsUnlocked: [],
                        userAgent: navigator.userAgent,
                        platform: navigator.platform
                    };
                }
                analyticsData.deviceStats[deviceId].lastSeen = timestamp;
                analyticsData.deviceStats[deviceId].viewCount++;
                
                if (!analyticsData.deviceStats[deviceId].scriptsViewed.includes(scriptId)) {
                    analyticsData.deviceStats[deviceId].scriptsViewed.push(scriptId);
                }
                
                // Save to localStorage for quick access
                localStorage.setItem('vertexhub_analytics', JSON.stringify({
                    deviceStats: analyticsData.deviceStats,
                    hourlyStats: analyticsData.hourlyStats
                }));
                
            } catch (error) {
                console.error('Error tracking detailed view:', error);
            }
            
            return viewData;
        }

        // Track unlock with detailed analytics
        async function trackDetailedUnlock(scriptId, completionTime, stepsCompleted) {
            const timestamp = Date.now();
            const hour = new Date(timestamp).getHours();
            const date = new Date(timestamp).toISOString().split('T')[0];
            
            const unlockData = {
                scriptId,
                userId: currentUser?.uid || 'anonymous',
                deviceId,
                timestamp,
                hour,
                date,
                completionTime,
                stepsCompleted,
                userAgent: navigator.userAgent,
                platform: navigator.platform
            };

            try {
                await db.collection('detailedAnalytics').add(unlockData);
                
                // Update stats
                if (!analyticsData.hourlyStats[date]) {
                    analyticsData.hourlyStats[date] = {};
                }
                if (!analyticsData.hourlyStats[date][hour]) {
                    analyticsData.hourlyStats[date][hour] = { views: 0, unlocks: 0 };
                }
                analyticsData.hourlyStats[date][hour].unlocks++;
                
                if (analyticsData.deviceStats[deviceId]) {
                    analyticsData.deviceStats[deviceId].unlockCount++;
                    if (!analyticsData.deviceStats[deviceId].scriptsUnlocked.includes(scriptId)) {
                        analyticsData.deviceStats[deviceId].scriptsUnlocked.push(scriptId);
                    }
                }
                
                // Update conversion funnel
                const funnelKey = `${date}_${scriptId}`;
                if (!analyticsData.conversionFunnels[funnelKey]) {
                    analyticsData.conversionFunnels[funnelKey] = {
                        views: 0,
                        step1: 0,
                        step2: 0,
                        step3: 0,
                        step4: 0,
                        step5: 0,
                        unlocks: 0
                    };
                }
                analyticsData.conversionFunnels[funnelKey].unlocks++;
                
            } catch (error) {
                console.error('Error tracking detailed unlock:', error);
            }
            
            return unlockData;
        }

        // Track step completion
        async function trackStepCompletion(scriptId, stepIndex, stepType, timeSpent) {
            const timestamp = Date.now();
            
            try {
                await db.collection('stepAnalytics').add({
                    scriptId,
                    userId: currentUser?.uid || 'anonymous',
                    deviceId,
                    stepIndex,
                    stepType,
                    timeSpent,
                    timestamp,
                    date: new Date(timestamp).toISOString().split('T')[0]
                });
                
                // Update funnel
                const date = new Date(timestamp).toISOString().split('T')[0];
                const funnelKey = `${date}_${scriptId}`;
                if (!analyticsData.conversionFunnels[funnelKey]) {
                    analyticsData.conversionFunnels[funnelKey] = {
                        views: 0,
                        step1: 0,
                        step2: 0,
                        step3: 0,
                        step4: 0,
                        step5: 0,
                        unlocks: 0
                    };
                }
                
                const stepNum = stepIndex + 1;
                if (stepNum === 1) analyticsData.conversionFunnels[funnelKey].step1++;
                else if (stepNum === 2) analyticsData.conversionFunnels[funnelKey].step2++;
                else if (stepNum === 3) analyticsData.conversionFunnels[funnelKey].step3++;
                else if (stepNum === 4) analyticsData.conversionFunnels[funnelKey].step4++;
                else if (stepNum === 5) analyticsData.conversionFunnels[funnelKey].step5++;
                
            } catch (error) {
                console.error('Error tracking step completion:', error);
            }
        }

        // ============ MULTI-PLATFORM VIDEO FUNCTIONS ============

        // Detect video platform from URL
        function detectVideoPlatform(url) {
            if (url.includes('youtube.com') || url.includes('youtu.be') || url.includes('youtube.com/shorts')) {
                return 'youtube';
            } else if (url.includes('rumble.com')) {
                return 'rumble';
            } else if (url.includes('tiktok.com')) {
                return 'tiktok';
            }
            return null;
        }

        // Extract video ID from URL based on platform
        function extractVideoId(url, platform) {
            switch(platform) {
                case 'youtube':
                    if (url.includes('youtube.com/shorts/')) {
                        return url.split('shorts/')[1].split('?')[0].split('/')[0];
                    } else if (url.includes('youtube.com/watch')) {
                        const urlParams = new URLSearchParams(new URL(url).search);
                        return urlParams.get('v');
                    } else if (url.includes('youtu.be/')) {
                        return url.split('youtu.be/')[1].split('?')[0];
                    }
                    break;
                    
                case 'rumble':
                    // Rumble URL format: https://rumble.com/vXXXXX-video-title.html
                    const rumbleMatch = url.match(/rumble\.com\/(v[0-9a-zA-Z]+)/);
                    if (rumbleMatch) {
                        return rumbleMatch[1];
                    }
                    break;
                    
                case 'tiktok':
                    // TikTok URL format: https://www.tiktok.com/@user/video/1234567890
                    const tiktokMatch = url.match(/\/video\/(\d+)/);
                    if (tiktokMatch) {
                        return tiktokMatch[1];
                    }
                    break;
            }
            return null;
        }

        // Generate embed URL based on platform
        function getEmbedUrl(url, platform, videoId) {
            switch(platform) {
                case 'youtube':
                    const isShorts = url.includes('shorts');
                    return `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&disablekb=1&fs=0&modestbranding=1&rel=0&showinfo=0&iv_load_policy=3&playsinline=1&enablejsapi=1`;
                    
                case 'rumble':
                    return `https://rumble.com/embed/${videoId}/?pub=4k2v3`;
                    
                case 'tiktok':
                    return `https://www.tiktok.com/embed/v2/${videoId}`;
                    
                default:
                    return url;
            }
        }

        // Open video in modal with platform-specific player
        function openVideoInModal(videoUrl, stepIndex, scriptId, requiredWatchTime) {
            const platform = detectVideoPlatform(videoUrl);
            const videoId = extractVideoId(videoUrl, platform);
            
            if (!platform || !videoId) {
                showCopyNotification('❌ Unsupported video URL or invalid format', true);
                return;
            }
            
            const embedUrl = getEmbedUrl(videoUrl, platform, videoId);
            const isShorts = platform === 'youtube' && videoUrl.includes('shorts');
            
            const modal = document.createElement('div');
            modal.className = 'video-modal';
            modal.id = 'video-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.98);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;
            
            modal.innerHTML = `
                <button class="video-close-btn" onclick="window.closeVideoModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10001;">
                    <i class="fas fa-times"></i>
                </button>
                <div class="video-modal-content" style="width: 100%; max-width: ${isShorts ? '400px' : '800px'}; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: white;">
                            <i class="${VIDEO_PLATFORMS[platform].icon}" style="color: ${VIDEO_PLATFORMS[platform].color};"></i>
                            Watch Required ${VIDEO_PLATFORMS[platform].name} Video
                        </h2>
                        <div style="color: var(--accent);" id="modal-countdown">Need to watch ${requiredWatchTime}s</div>
                    </div>
                    
                    <div class="${isShorts ? 'custom-shorts-container' : 'video-platform-container'}" style="position: relative; width: 100%; border-radius: 28px; overflow: hidden; box-shadow: 0 0 0 2px rgba(99,102,241,0.3); aspect-ratio: ${isShorts ? '9 / 16' : '16 / 9'}; background: black;">
                        <iframe id="modal-video-iframe" class="video-embed" src="${embedUrl}" 
                                frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" 
                                allowfullscreen style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;">
                        </iframe>
                        <div class="video-overlay" id="modal-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"></div>
                        <div class="video-timer-progress" id="modal-progress-bar" style="position: absolute; bottom: 0; left: 0; height: 4px; background: var(--gradient-primary); width: 0%; z-index: 15;"></div>
                        <div class="video-timer-display" id="modal-timer" style="position: absolute; bottom: 20px; right: 20px; background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 100px; font-size: 18px; z-index: 20;">
                            Loading...
                        </div>
                        <div class="video-warning" id="modal-warning" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(239,68,68,0.9); color: white; padding: 8px 16px; border-radius: 100px; font-size: 14px; z-index: 30; display: none;">
                            ⚠️ Don't skip! Watch required time!
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <p style="color: var(--accent);" id="modal-complete-message"></p>
                        <div class="timer-progress-bar" style="width: 100%; height: 12px; background: var(--dark-input); border-radius: 100px; overflow: hidden; margin: 15px 0 8px;">
                            <div id="modal-watch-progress" class="timer-progress-fill" style="height: 100%; background: var(--gradient-primary); width: 0%;"></div>
                        </div>
                        <p style="color: var(--text-dim);">
                            <i class="fas fa-shield"></i> 
                            Must watch ${requiredWatchTime} seconds
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('video-modal-container').appendChild(modal);
            currentVideoModal = modal;
            
            const watchState = {
                stepIndex: stepIndex,
                scriptId: scriptId,
                completed: false,
                skipAttempts: 0,
                requiredWatchTime: requiredWatchTime,
                watchedSeconds: 0,
                watchCompleted: false,
                platform: platform,
                lastVideoTime: 0,
                videoDuration: 0
            };
            
            // Set up video tracking based on platform
            setTimeout(() => {
                const iframe = document.getElementById('modal-video-iframe');
                
                if (platform === 'youtube') {
                    setupYouTubeTracking(iframe, watchState);
                } else {
                    // For Rumble and TikTok, use interval-based tracking
                    setupGenericVideoTracking(iframe, watchState);
                }
            }, 1000);
            
            // Block user interactions
            const overlay = document.getElementById('modal-overlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSkipAttempt('click', watchState);
                });
                
                overlay.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            }
            
            // Block keyboard shortcuts
            const keyHandler = (e) => {
                if ([32, 33, 34, 35, 36, 37, 38, 39, 40].includes(e.keyCode)) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleSkipAttempt('keyboard', watchState);
                    return false;
                }
            };
            
            window.addEventListener('keydown', keyHandler, true);
            
            // Clean up on modal close
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (!document.body.contains(document.getElementById('video-modal'))) {
                        window.removeEventListener('keydown', keyHandler, true);
                        observer.disconnect();
                    }
                });
            });
            
            observer.observe(document.body, { childList: true, subtree: true });
        }

        function setupYouTubeTracking(iframe, watchState) {
            // Create YouTube player instance
            const player = new YT.Player('modal-video-iframe', {
                events: {
                    'onReady': (event) => {
                        watchState.player = event.target;
                        watchState.player.mute();
                        watchState.player.playVideo();
                        
                        setTimeout(() => {
                            try {
                                watchState.videoDuration = watchState.player.getDuration();
                            } catch (e) {}
                        }, 1000);
                    },
                    'onStateChange': (event) => {
                        if (watchState.completed) return;
                        
                        if (event.data === YT.PlayerState.PAUSED) {
                            setTimeout(() => {
                                if (watchState.player && !watchState.completed) {
                                    watchState.player.playVideo();
                                }
                            }, 500);
                        }
                        
                        if (event.data === YT.PlayerState.ENDED && !watchState.watchCompleted) {
                            setTimeout(() => {
                                try {
                                    watchState.player.playVideo();
                                    watchState.player.seekTo(0, true);
                                } catch (e) {}
                            }, 500);
                        }
                    }
                }
            });
            
            // Start tracking
            const timerInterval = setInterval(() => {
                if (watchState.completed || !document.getElementById('video-modal')) {
                    clearInterval(timerInterval);
                    return;
                }
                
                try {
                    if (!watchState.player) return;
                    
                    const currentTime = watchState.player.getCurrentTime();
                    const playerState = watchState.player.getPlayerState();
                    
                    if (!currentTime) return;
                    
                    if (playerState !== YT.PlayerState.PLAYING && !watchState.watchCompleted) {
                        watchState.player.playVideo();
                    }
                    
                    if (playerState === YT.PlayerState.PLAYING && !watchState.watchCompleted) {
                        watchState.watchedSeconds = currentTime;
                        
                        const watchProgress = document.getElementById('modal-watch-progress');
                        if (watchProgress) {
                            const progressPercent = Math.min((currentTime / watchState.requiredWatchTime) * 100, 100);
                            watchProgress.style.width = progressPercent + '%';
                        }
                    }
                    
                    // Check for skips
                    if (watchState.lastVideoTime > 0 && currentTime > watchState.lastVideoTime + 2) {
                        handleSkipAttempt('skip', watchState, currentTime - watchState.lastVideoTime);
                        watchState.player.seekTo(watchState.lastVideoTime, true);
                    } else {
                        watchState.lastVideoTime = currentTime;
                    }
                    
                    const timerDisplay = document.getElementById('modal-timer');
                    if (timerDisplay) {
                        timerDisplay.innerHTML = `${formatTime(currentTime)} / ${formatTime(watchState.videoDuration)} (need ${watchState.requiredWatchTime}s)`;
                    }
                    
                    const progressBar = document.getElementById('modal-progress-bar');
                    if (progressBar && watchState.videoDuration) {
                        const progressPercent = (currentTime / watchState.videoDuration) * 100;
                        progressBar.style.width = progressPercent + '%';
                    }
                    
                    if (currentTime >= watchState.requiredWatchTime && !watchState.watchCompleted) {
                        completeVideoWatch(watchState);
                    }
                } catch (e) {}
            }, 100);
        }

        function setupGenericVideoTracking(iframe, watchState) {
            let startTime = Date.now();
            
            const timerInterval = setInterval(() => {
                if (watchState.completed || !document.getElementById('video-modal')) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsedSeconds = (Date.now() - startTime) / 1000;
                watchState.watchedSeconds = elapsedSeconds;
                
                const watchProgress = document.getElementById('modal-watch-progress');
                if (watchProgress) {
                    const progressPercent = Math.min((elapsedSeconds / watchState.requiredWatchTime) * 100, 100);
                    watchProgress.style.width = progressPercent + '%';
                }
                
                const timerDisplay = document.getElementById('modal-timer');
                if (timerDisplay) {
                    timerDisplay.innerHTML = `${formatTime(elapsedSeconds)} / need ${watchState.requiredWatchTime}s`;
                }
                
                const progressBar = document.getElementById('modal-progress-bar');
                if (progressBar) {
                    const progressPercent = Math.min((elapsedSeconds / watchState.requiredWatchTime) * 100, 100);
                    progressBar.style.width = progressPercent + '%';
                }
                
                if (elapsedSeconds >= watchState.requiredWatchTime && !watchState.watchCompleted) {
                    completeVideoWatch(watchState);
                }
            }, 100);
        }

        function handleSkipAttempt(reason, watchState, amount = 0) {
            if (watchState.completed || watchState.watchCompleted) return;
            
            watchState.skipAttempts++;
            
            const warning = document.getElementById('modal-warning');
            if (warning) {
                warning.style.display = 'block';
                setTimeout(() => {
                    warning.style.display = 'none';
                }, 3000);
            }
            
            let message = `⚠️ Skip detected! Attempt ${watchState.skipAttempts}/3`;
            if (reason === 'keyboard') message = '⚠️ Keyboard controls disabled! ' + message;
            if (reason === 'click') message = '⚠️ Don\'t click the video! ' + message;
            
            showCopyNotification(message, true);
            
            if (watchState.skipAttempts >= 3) {
                showCopyNotification('❌ Too many skips - Please restart', true);
                window.closeVideoModal();
            }
        }

        function completeVideoWatch(watchState) {
            watchState.watchCompleted = true;
            watchState.completed = true;
            
            const completeMessage = document.getElementById('modal-complete-message');
            if (completeMessage) {
                completeMessage.innerHTML = `✅ Watched ${watchState.requiredWatchTime}s!`;
                completeMessage.style.color = '#10b981';
            }
            
            const countdown = document.getElementById('modal-countdown');
            if (countdown) {
                countdown.innerHTML = '✓ Completed! Closing...';
            }
            
            const script = window.currentUnlockScript;
            if (script) {
                activeStepStates[watchState.stepIndex].videoCompleted = true;
                activeStepStates[watchState.stepIndex].showingVideo = false;
                renderUnlockSteps(script);
                
                // Track step completion
                trackStepCompletion(
                    script.id, 
                    watchState.stepIndex, 
                    script.steps[watchState.stepIndex].type,
                    watchState.requiredWatchTime
                );
                
                setTimeout(() => {
                    startStepTimerAfterVideo(watchState.stepIndex);
                }, 500);
            }
            
            setTimeout(() => {
                window.closeVideoModal();
            }, 1500);
        }

        window.closeVideoModal = function() {
            const modal = document.getElementById('video-modal');
            if (modal) {
                modal.remove();
            }
            currentVideoModal = null;
            
            const script = window.currentUnlockScript;
            if (script) {
                renderUnlockSteps(script);
            }
        };

        // ============ ENHANCED ANALYTICS DASHBOARD ============

        async function showEnhancedAnalytics() {
            const container = document.getElementById('main-content');
            if (!container) return;
            
            // Load detailed analytics from Firestore
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const analyticsSnapshot = await db.collection('detailedAnalytics')
                .where('userId', '==', currentUser?.uid || 'anonymous')
                .where('timestamp', '>=', thirtyDaysAgo.getTime())
                .orderBy('timestamp', 'desc')
                .get();
            
            const stepSnapshot = await db.collection('stepAnalytics')
                .where('userId', '==', currentUser?.uid || 'anonymous')
                .where('timestamp', '>=', thirtyDaysAgo.getTime())
                .get();
            
            const myScriptsSnapshot = await db.collection('scripts')
                .where('ownerId', '==', currentUser?.uid)
                .get();
            
            const myScripts = myScriptsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            const analytics = analyticsSnapshot.docs.map(doc => doc.data());
            const stepAnalytics = stepSnapshot.docs.map(doc => doc.data());
            
            // Calculate metrics
            const totalViews = analytics.filter(a => a.type === 'view' || !a.type).length;
            const totalUnlocks = analytics.filter(a => a.type === 'unlock').length;
            const uniqueDevices = [...new Set(analytics.map(a => a.deviceId))].length;
            const uniqueViews = [...new Set(analytics.filter(a => a.type === 'view').map(a => a.deviceId))].length;
            const uniqueUnlocks = [...new Set(analytics.filter(a => a.type === 'unlock').map(a => a.deviceId))].length;
            
            // Calculate conversion rate
            const conversionRate = totalViews > 0 ? ((totalUnlocks / totalViews) * 100).toFixed(1) : 0;
            const uniqueConversionRate = uniqueViews > 0 ? ((uniqueUnlocks / uniqueViews) * 100).toFixed(1) : 0;
            
            // Calculate average completion time
            const completionTimes = analytics.filter(a => a.completionTime).map(a => a.completionTime);
            const avgCompletionTime = completionTimes.length > 0 
                ? (completionTimes.reduce((a, b) => a + b, 0) / completionTimes.length).toFixed(0)
                : 0;
            
            // Get top performing scripts
            const scriptPerformance = myScripts.map(script => {
                const scriptViews = analytics.filter(a => a.scriptId === script.id && (!a.type || a.type === 'view')).length;
                const scriptUnlocks = analytics.filter(a => a.scriptId === script.id && a.type === 'unlock').length;
                const scriptRate = scriptViews > 0 ? ((scriptUnlocks / scriptViews) * 100).toFixed(1) : 0;
                return {
                    ...script,
                    views: scriptViews,
                    unlocks: scriptUnlocks,
                    rate: scriptRate
                };
            }).sort((a, b) => b.unlocks - a.unlocks);
            
            // Generate hourly chart data
            const hourlyData = {};
            for (let i = 0; i < 24; i++) {
                hourlyData[i] = { views: 0, unlocks: 0 };
            }
            
            analytics.forEach(a => {
                const hour = new Date(a.timestamp).getHours();
                if (hourlyData[hour]) {
                    if (a.type === 'unlock') {
                        hourlyData[hour].unlocks++;
                    } else {
                        hourlyData[hour].views++;
                    }
                }
            });
            
            const maxHourlyViews = Math.max(...Object.values(hourlyData).map(h => h.views), 1);
            
            // Generate chart HTML
            let chartHTML = '';
            for (let i = 0; i < 24; i++) {
                const hourViews = hourlyData[i].views;
                const heightPercent = (hourViews / maxHourlyViews) * 100;
                chartHTML += `
                    <div class="chart-bar-container">
                        <div class="chart-bar" style="height: ${Math.max(heightPercent, 4)}%;">
                            <span class="chart-bar-value">${hourViews} views</span>
                        </div>
                        <span class="chart-label">${i}:00</span>
                    </div>
                `;
            }
            
            // Generate device stats
            let deviceHTML = '';
            const devices = Object.values(analyticsData.deviceStats || {}).slice(0, 5);
            devices.forEach(device => {
                deviceHTML += `
                    <div class="device-stat-card">
                        <div class="device-stat-value">${device.viewCount}</div>
                        <div class="device-stat-label">Views</div>
                        <div class="device-stat-detail">
                            <i class="fas fa-mobile-alt"></i> ${device.platform || 'Unknown'}<br>
                            Unlocks: ${device.unlockCount}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = `
                <div style="max-width: 1400px; margin: 0 auto;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px;">
                        <h1 class="section-title">
                            <i class="fas fa-chart-pie" style="color: #6366f1;"></i>
                            Advanced Analytics
                        </h1>
                        <div class="export-buttons">
                            <button class="export-btn" onclick="exportAnalytics('csv')">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                            <button class="export-btn" onclick="exportAnalytics('json')">
                                <i class="fas fa-file-code"></i> Export JSON
                            </button>
                            <button class="export-btn" onclick="exportAnalytics('pdf')">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="realtime-stats">
                        <div class="realtime-indicator">
                            <span class="pulse-dot"></span>
                            <span>Live Stats</span>
                        </div>
                        <div>
                            <i class="fas fa-eye"></i> Views today: ${analytics.filter(a => new Date(a.timestamp).toDateString() === new Date().toDateString()).length}
                            <span style="margin-left: 16px;"><i class="fas fa-unlock"></i> Unlocks today: ${analytics.filter(a => a.type === 'unlock' && new Date(a.timestamp).toDateString() === new Date().toDateString()).length}</span>
                        </div>
                    </div>
                    
                    <div class="stats-grid-enhanced">
                        <div class="stat-card-enhanced">
                            <div class="stat-header">
                                <span class="stat-icon"><i class="fas fa-eye"></i></span>
                                <span class="stat-trend trend-up"><i class="fas fa-arrow-up"></i> +12%</span>
                            </div>
                            <div class="stat-value-large">${totalViews}</div>
                            <div class="stat-label">Total Views</div>
                            <div class="stat-trend">
                                <i class="fas fa-mobile-alt"></i> Unique: ${uniqueViews}
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced">
                            <div class="stat-header">
                                <span class="stat-icon"><i class="fas fa-unlock"></i></span>
                                <span class="stat-trend trend-up"><i class="fas fa-arrow-up"></i> +8%</span>
                            </div>
                            <div class="stat-value-large">${totalUnlocks}</div>
                            <div class="stat-label">Total Unlocks</div>
                            <div class="stat-trend">
                                <i class="fas fa-mobile-alt"></i> Unique: ${uniqueUnlocks}
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced">
                            <div class="stat-header">
                                <span class="stat-icon"><i class="fas fa-chart-line"></i></span>
                            </div>
                            <div class="stat-value-large">${conversionRate}%</div>
                            <div class="stat-label">Conversion Rate</div>
                            <div class="stat-trend">
                                <i class="fas fa-check-circle"></i> Unique: ${uniqueConversionRate}%
                            </div>
                        </div>
                        
                        <div class="stat-card-enhanced">
                            <div class="stat-header">
                                <span class="stat-icon"><i class="fas fa-clock"></i></span>
                            </div>
                            <div class="stat-value-large">${avgCompletionTime}s</div>
                            <div class="stat-label">Avg Completion</div>
                            <div class="stat-trend">
                                <i class="fas fa-chart-bar"></i> Steps: ${stepAnalytics.length}
                            </div>
                        </div>
                    </div>
                    
                    <div class="analytics-chart">
                        <div class="chart-header">
                            <h3>24-Hour Activity</h3>
                            <div style="display: flex; gap: 16px;">
                                <span><i class="fas fa-eye" style="color: #6366f1;"></i> Views</span>
                                <span><i class="fas fa-unlock" style="color: #10b981;"></i> Unlocks</span>
                            </div>
                        </div>
                        <div class="chart-bars">
                            ${chartHTML}
                        </div>
                    </div>
                    
                    <div class="funnel-container">
                        <div class="funnel-step">
                            <div class="funnel-value">${totalViews}</div>
                            <div class="funnel-label">Views</div>
                            <div class="funnel-rate">100%</div>
                        </div>
                        <div class="funnel-step">
                            <div class="funnel-value">${stepAnalytics.filter(s => s.stepIndex === 0).length}</div>
                            <div class="funnel-label">Step 1</div>
                            <div class="funnel-rate">${totalViews > 0 ? ((stepAnalytics.filter(s => s.stepIndex === 0).length / totalViews) * 100).toFixed(1) : 0}%</div>
                        </div>
                        <div class="funnel-step">
                            <div class="funnel-value">${stepAnalytics.filter(s => s.stepIndex === 1).length}</div>
                            <div class="funnel-label">Step 2</div>
                            <div class="funnel-rate">${totalViews > 0 ? ((stepAnalytics.filter(s => s.stepIndex === 1).length / totalViews) * 100).toFixed(1) : 0}%</div>
                        </div>
                        <div class="funnel-step">
                            <div class="funnel-value">${stepAnalytics.filter(s => s.stepIndex === 2).length}</div>
                            <div class="funnel-label">Step 3</div>
                            <div class="funnel-rate">${totalViews > 0 ? ((stepAnalytics.filter(s => s.stepIndex === 2).length / totalViews) * 100).toFixed(1) : 0}%</div>
                        </div>
                        <div class="funnel-step">
                            <div class="funnel-value">${totalUnlocks}</div>
                            <div class="funnel-label">Unlocks</div>
                            <div class="funnel-rate">${conversionRate}%</div>
                        </div>
                    </div>
                    
                    <h2 style="margin: 40px 0 20px;">Top Performing Scripts</h2>
                    <div class="scripts-grid">
                        ${scriptPerformance.map(script => `
                            <div class="script-card">
                                <div class="script-header">
                                    <h3 class="script-title">${script.title || 'Unnamed'}</h3>
                                </div>
                                <div class="script-stats">
                                    <div class="stat-item">
                                        <div class="stat-value">${script.views}</div>
                                        <div class="stat-label">Views</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${script.unlocks}</div>
                                        <div class="stat-label">Unlocks</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value">${script.rate}%</div>
                                        <div class="stat-label">Rate</div>
                                    </div>
                                </div>
                                <div style="padding: 16px; border-top: 1px solid var(--border);">
                                    <button class="copy-btn" style="width: 100%;" onclick="window.location.hash='#script-${script.id}'">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <h2 style="margin: 40px 0 20px;">Device Analytics</h2>
                    <div class="device-stats-grid">
                        ${deviceHTML || '<p style="color: var(--text-dim);">No device data available</p>'}
                    </div>
                    
                    <div class="analytics-chart">
                        <h3 style="margin-bottom: 20px;">Step Completion Breakdown</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            ${[1,2,3,4,5].map(stepNum => {
                                const stepCount = stepAnalytics.filter(s => s.stepIndex === stepNum-1).length;
                                const prevStepCount = stepNum > 1 ? stepAnalytics.filter(s => s.stepIndex === stepNum-2).length : totalViews;
                                const dropoff = prevStepCount > 0 ? ((1 - stepCount/prevStepCount) * 100).toFixed(1) : 0;
                                return `
                                    <div style="background: rgba(0,0,0,0.3); border-radius: 16px; padding: 16px;">
                                        <div style="font-size: 24px; font-weight: 700;">${stepCount}</div>
                                        <div style="color: var(--text-dim);">Step ${stepNum} Completions</div>
                                        <div style="color: ${dropoff > 50 ? '#ef4444' : '#10b981'}; margin-top: 8px;">
                                            <i class="fas fa-arrow-${dropoff > 50 ? 'down' : 'up'}"></i> ${dropoff}% dropoff
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Export analytics function
        window.exportAnalytics = async function(format) {
            const analyticsSnapshot = await db.collection('detailedAnalytics')
                .where('userId', '==', currentUser?.uid || 'anonymous')
                .get();
            
            const data = analyticsSnapshot.docs.map(doc => doc.data());
            
            if (format === 'json') {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vertexhub_analytics_${new Date().toISOString()}.json`;
                a.click();
            } else if (format === 'csv') {
                // Convert to CSV
                const headers = ['Date', 'Script ID', 'Type', 'Device ID', 'Platform', 'Time'];
                const rows = data.map(d => [
                    new Date(d.timestamp).toLocaleDateString(),
                    d.scriptId,
                    d.type || 'view',
                    d.deviceId,
                    d.platform || 'unknown',
                    d.completionTime || ''
                ]);
                
                const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `vertexhub_analytics_${new Date().toISOString()}.csv`;
                a.click();
            }
            
            showCopyNotification(`✅ Analytics exported as ${format.toUpperCase()}`);
        };

        // ============ MODIFIED HANDLE STEP CLICK FOR MULTI-PLATFORM ============

        window.handleStepClick = function(stepIndex) {
            const script = window.currentUnlockScript;
            if (!script) return;
            
            const state = activeStepStates[stepIndex];
            const step = script.steps[stepIndex];
            
            if (script.sequentialRequired && stepIndex > 0) {
                const prevStep = activeStepStates[stepIndex - 1];
                if (!prevStep?.timerComplete) {
                    showCopyNotification('⚠️ Complete previous step first!', true);
                    return;
                }
            }
            
            if (state.linkClicked || state.timerComplete) return;
            
            if (step.type === 'watch') {
                if (!state.videoCompleted) {
                    state.showingVideo = true;
                    renderUnlockSteps(script);
                    
                    // Check if it's a supported video platform
                    const platform = detectVideoPlatform(step.url);
                    if (platform) {
                        openVideoInModal(step.url, stepIndex, script.id, step.watchTime || 20);
                    } else {
                        // Fallback to regular link
                        window.open(step.url, '_blank');
                        startStepTimer(stepIndex);
                        showCopyNotification(`✅ Timer started (${step.waitTime || 20}s)`, false);
                    }
                } else {
                    startStepTimerAfterVideo(stepIndex);
                }
            } else {
                window.open(step.url, '_blank');
                startStepTimer(stepIndex);
                showCopyNotification(`✅ Timer started (${step.waitTime || 20}s)`, false);
            }
        };

        // ============ MODIFIED FINAL UNLOCK WITH ENHANCED TRACKING ============

        window.finalUnlock = async function(scriptId) {
            const script = window.currentUnlockScript;
            if (!script) return;
            
            const allCompleted = Object.values(activeStepStates).every(s => s.timerComplete);
            if (!allCompleted) {
                showCopyNotification('⚠️ Complete all steps first!', true);
                return;
            }
            
            // Check again if already unlocked
            const alreadyUnlocked = await hasDeviceUnlocked(scriptId);
            if (alreadyUnlocked) {
                showCopyNotification('⚠️ You already unlocked this!', true);
                window.location.href = script.unlockUrl;
                return;
            }
            
            // Calculate completion time
            const startTime = script.startTime || Date.now();
            const completionTime = Math.round((Date.now() - startTime) / 1000);
            const stepsCompleted = script.steps.length;
            
            try {
                // Track detailed unlock
                await trackDetailedUnlock(scriptId, completionTime, stepsCompleted);
                
                // Track unlock in analytics
                await db.collection('analytics').add({
                    scriptId: scriptId,
                    type: 'unlock',
                    userId: currentUser?.uid || 'anonymous',
                    deviceId: deviceId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    completionTime: completionTime,
                    stepsCompleted: stepsCompleted
                });
                
                // Update script counts
                const scriptRef = db.collection('scripts').doc(scriptId);
                await scriptRef.update({
                    unlocks: firebase.firestore.FieldValue.increment(1),
                    'unlocks.unique': firebase.firestore.FieldValue.arrayUnion(deviceId),
                    totalCompletionTime: firebase.firestore.FieldValue.increment(completionTime)
                });
                
                // Update creator stats
                if (script.ownerId) {
                    await db.collection('users').doc(script.ownerId).update({
                        totalUnlocks: firebase.firestore.FieldValue.increment(1)
                    }).catch(e => console.log('Creator stats update error:', e));
                }
                
                // Record unlock
                if (currentUser) {
                    unlockedScripts[scriptId] = true;
                    await saveUserUnlocks();
                    
                    await db.collection('scriptUnlocks').doc(`${scriptId}_${currentUser.uid}`).set({
                        scriptId: scriptId,
                        userId: currentUser.uid,
                        deviceId: deviceId,
                        completionTime: completionTime,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    if (!deviceInteractions.unlockedScripts) deviceInteractions.unlockedScripts = {};
                    deviceInteractions.unlockedScripts[scriptId] = true;
                    saveDeviceInteractions();
                }
                
                showCopyNotification(`✅ Content unlocked! (${completionTime}s)`, false);
                
                setTimeout(() => {
                    window.location.href = script.unlockUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Error during unlock:', error);
                showCopyNotification('❌ Error unlocking: ' + error.message, true);
            }
        };

        // ============ MODIFIED LOAD SCRIPT VIEW WITH START TIME ============

        async function loadScriptView(scriptId) {
            // ... (keep existing loadScriptView code)
            const result = await loadScriptById(scriptId);
            
            if (result.success) {
                const script = result.script;
                
                // Track detailed view
                await trackDetailedView(scriptId);
                
                // Set start time for completion tracking
                script.startTime = Date.now();
                
                // ... rest of existing loadScriptView code
            }
        }

        // ============ UPDATE MY ANALYTICS TO USE ENHANCED VIEW ============

        window.showMyAnalytics = async function() {
            showEnhancedAnalytics();
        };

        // ============ UPDATE DASHBOARD STATS TO SHOW ENHANCED METRICS ============

        async function renderDashboard(filterType = 'all', searchTerm = '') {
            // ... keep existing renderDashboard code but update stats display
            await loadAllScripts();
            
            // Calculate enhanced stats for display
            const totalUniqueViews = allScripts.reduce((sum, script) => sum + (script.views?.unique?.length || 0), 0);
            const totalUniqueUnlocks = allScripts.reduce((sum, script) => sum + (script.unlocks?.unique?.length || 0), 0);
            const totalViews = allScripts.reduce((sum, script) => sum + (script.views?.total || 0), 0);
            const totalUnlocks = allScripts.reduce((sum, script) => sum + (script.unlocks?.total || 0), 0);
            
            // ... rest of renderDashboard
        }

        // ============ INITIALIZE ============

        window.onload = function() {
            init();
            
            // Load analytics from localStorage
            const storedAnalytics = localStorage.getItem('vertexhub_analytics');
            if (storedAnalytics) {
                analyticsData = JSON.parse(storedAnalytics);
            }
            
            window.addEventListener('hashchange', handleRouting);
        };

        // ... keep all existing code from the original script (auth, templates, admin panel, etc.)

        // Note: Due to length constraints, I've shown the key enhancements.
        // The complete script would include all original functionality plus these enhancements.
    </script>
</body>
</html>
